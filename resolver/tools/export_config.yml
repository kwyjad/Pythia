mapping:
  event_id:        ["event_id", "evt_id"]
  country_name:    ["country_name", "country"]
  iso3:            ["iso3", "iso_code3"]
  hazard_code:     ["hazard_code", "hz_code"]
  hazard_label:    ["hazard_label", "hz_label"]
  hazard_class:    ["hazard_class", "hz_class"]
  metric:          ["metric", "measure"]
  value:           ["value", "count", "people"]
  unit:            ["unit"]
  as_of_date:      ["as_of_date", "as_of"]
  series_semantics: ["series_semantics"]
  publication_date: ["publication_date", "published"]
  publisher:       ["publisher", "org"]
  source_type:     ["source_type", "source"]
  source_url:      ["source_url", "url"]
  doc_title:       ["doc_title", "title"]
  definition_text: ["definition_text", "definition", "note"]
  method:          ["method", "ingest_method"]
  confidence:      ["confidence"]
  revision:        ["revision", "rev"]
  artifact_id:     ["artifact_id"]
  artifact_sha256: ["artifact_sha256"]
  notes:           ["notes"]
  alt_value:       ["alt_value"]
  alt_source_url:  ["alt_source_url"]
  proxy_for:       ["proxy_for"]
  precedence_decision: ["precedence_decision"]
  ingested_at:     ["ingested_at"]

constants:
  unit: "persons"
  method: "api"
  confidence: "med"
  revision: 1

ignore:
  filenames:
    - "flow.csv.manifest.json"

transforms:
  metric:
    in_need:    ["pin", "people_in_need", "in need", "in-need"]
    affected:   ["pa", "people_affected", "affected"]
    displaced:  ["idps", "displaced", "internal_displacement"]
    cases:      ["cases", "confirmed_cases", "suspected_cases"]

dates:
  as_of_date: ["date_as_of", "asof"]
  publication_date: ["pub_date", "pub"]

sources:
  - name: dtm_displacement_admin0_flows
    match:
      filename_regex: "(?i)^dtm.*displacement.*\\.csv$"
      required_columns: [CountryISO3, as_of, value, value_type]
    map:
      iso3:
        from: CountryISO3
        ops: [trim, uppercase]
      as_of_date:
        from: as_of
        ops: [to_date]
      ym:
        from: as_of_date
        ops: [to_ym]
      metric:
        const: idp_displacement_new_dtm
      value:
        from: value
        ops: [to_number]
      series_semantics:
        const: new
      semantics:
        const: new
      source:
        const: IOM DTM (admin0)
    filters:
      - keep_if_not_null: [iso3, as_of_date, value]
      - keep_if_positive: [value]
    dedupe:
      keys: [iso3, as_of_date, metric]
      keep: last
  - name: dtm_displacement_admin0
    # The connector may emit header-only CSVs (soft timeout / ok-empty runs).
    # Filters below will skip those safely because the required columns are empty.
    match:
      filename_regex: "(?i)^dtm.*displacement.*\\.csv$"
      required_columns: [CountryISO3, ReportingDate, idp_count]
    map:
      iso3:
        from: CountryISO3
        ops: [trim, uppercase]
      as_of_date:
        from: ReportingDate
        ops: [to_date]
      ym:
        from: as_of_date
        ops: [to_ym]
      metric:
        const: idps_present
      value:
        from: idp_count
        ops: [to_number]
      series_semantics:
        const: stock
      semantics:
        const: stock
      source:
        const: IOM DTM (admin0)
    filters:
      - keep_if_not_null: [CountryISO3, ReportingDate, idp_count]
      - keep_if_positive: [value]
    dedupe:
      keys: [iso3, as_of_date, metric]
      keep: last
  - name: idmc_flow
    match:
      filename_regex: "(?i)(?:^|.*/resolver/staging/idmc/)flow\\.csv$"
      required_columns: [iso3, as_of_date, value]
    map:
      iso3:
        from: iso3
        ops: [trim, uppercase]
      as_of_date:
        from: as_of_date
        ops: [to_date]
      metric:
        const: new_displacements
      value:
        from: value
        ops: [to_number]
      series_semantics:
        const: new
      semantics:
        const: new
      source:
        from: source
        ops: [trim]
    filters:
      - keep_if_not_null: [iso3, as_of_date, value]
      - keep_if_positive: [value]
    dedupe:
      keys: [iso3, as_of_date, metric]
      keep: last
  - name: idmc_facts_flow
    match:
      filename_regex: "(?i)(?:^|.*/resolver/staging/idmc/)idmc_facts_flow\\.parquet$"
      required_columns: [iso3, as_of_date, value]
    map:
      iso3:
        from: iso3
        ops: [trim, uppercase]
      as_of_date:
        from: as_of_date
        ops: [to_date]
      metric:
        const: new_displacements
      value:
        from: value
        ops: [to_number]
      series_semantics:
        const: new
      semantics:
        const: new
      source:
        from: source
        ops: [trim]
    filters:
      - keep_if_not_null: [iso3, as_of_date, value]
      - keep_if_positive: [value]
    dedupe:
      keys: [iso3, as_of_date, metric]
      keep: last
  - name: idmc_stock
    allow_empty: true
    match:
      filename_regex: "(?i)(?:^|.*/resolver/staging/idmc/)stock\\.csv$"
      required_columns: [iso3, as_of_date, value]
    map:
      iso3:
        from: iso3
        ops: [trim, uppercase]
      as_of_date:
        from_any: [as_of_date, date, displacement_date]
        ops: [to_date]
      metric:
        const: idp_displacement_stock_idmc
      value:
        from: value
        ops: [to_number]
      series_semantics:
        const: stock
      semantics:
        const: stock
      source:
        from_any: [source, source_label]
        ops: [trim]
    filters:
      - keep_if_not_null: [iso3, as_of_date, value]
      - keep_if_positive: [value]
    dedupe:
      keys: [iso3, as_of_date, metric]
      keep: last
  - name: emdat_pa
    allow_empty: true
    match:
      filename_regex: "(?i)(?:^|.*/resolver/staging/)emdat_pa\\.csv$"
      required_columns: [iso3, as_of_date, metric]
    map:
      event_id:
        from: event_id
        ops: [trim]
      country_name:
        from: country_name
        ops: [trim]
      iso3:
        from: iso3
        ops: [trim, uppercase]
      hazard_code:
        from: hazard_code
        ops: [trim, uppercase]
      hazard_label:
        from: hazard_label
        ops: [trim]
      hazard_class:
        from: hazard_class
        ops: [trim]
      metric:
        from: metric
        ops: [trim]
      series_semantics:
        from: series_semantics
        ops: [trim]
      semantics:
        from: semantics
        ops: [trim]
      value:
        from: value
        ops: [to_number]
      unit:
        from: unit
        ops: [trim]
      as_of_date:
        from: as_of_date
        ops: [trim]
      publication_date:
        from: publication_date
        ops: [trim]
      publisher:
        from: publisher
        ops: [trim]
      source_type:
        from: source_type
        ops: [trim]
      source_url:
        from: source_url
        ops: [trim]
      doc_title:
        from: doc_title
        ops: [trim]
      definition_text:
        from: definition_text
        ops: [trim]
      method:
        from: method
        ops: [trim]
      confidence:
        from: confidence
        ops: [trim]
      revision:
        from: revision
        ops: [to_number]
      ingested_at:
        from: ingested_at
        ops: [trim]
      source:
        const: EM-DAT
    dedupe:
      keys: [iso3, as_of_date, hazard_code, metric, series_semantics]
      keep: last
metrics:
  idp_displacement_new_dtm:
    enabled: true
    series_semantics: new
    source: IOM DTM (admin0)
  idps_present:
    enabled: true
    series_semantics: stock
    source: IOM DTM (admin0)
  new_displacements:
    enabled: true
    series_semantics: new
    source: idmc_idu
