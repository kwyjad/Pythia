<!--- DO NOT EDIT: generated by resolver/tools/generate_schemas_md.py on 2025-10-22Z -->

# Resolver Schemas

## Table of contents

- [staging.common](#stagingcommon)
- [staging.reliefweb_pdf](#stagingreliefwebpdf)
- [staging.unhcr_odp](#stagingunhcrodp)
- [staging.worldpop](#stagingworldpop)
- [staging.dtm_displacement](#stagingdtm_displacement)
- [db.facts_raw](#dbfactsraw)
- [db.facts_resolved](#dbfactsresolved)
- [db.facts_deltas](#dbfactsdeltas)
- [db.snapshots](#dbsnapshots)
- [db.manifests](#dbmanifests)
- [context.facts_last12](#contextfacts_last12)
- [Ingestion Diagnostics Schema](#ingestion-diagnostics-schema)
- [Export configuration (`resolver/tools/export_config.yml`)](#export-configuration-resolvertoolsexport_configyml)

## staging.common

Canonical staging columns for event-centric connectors.

| Name | Type | Required | Enum/Format | Description |
| --- | --- | --- | --- | --- |
| event_id | string | yes |  |  |
| country_name | string | yes |  |  |
| iso3 | string | yes |  |  |
| hazard_code | string | yes |  |  |
| hazard_label | string | yes |  |  |
| hazard_class | string | yes |  |  |
| metric | enum | yes | in_need, affected, displaced, cases, fatalities<br>events, participants |  |
| series_semantics | enum | no | stock, new |  |
| value | number | yes |  |  |
| unit | enum | yes | persons, persons_cases, events |  |
| as_of_date | string | yes |  | ISO-8601 date (YYYY-MM-DD) |
| publication_date | string | yes |  | ISO-8601 date (YYYY-MM-DD) |
| publisher | string | yes |  |  |
| source_type | string | yes |  |  |
| source_url | string | yes |  |  |
| doc_title | string | yes |  |  |
| definition_text | string | yes |  |  |
| method | string | yes |  |  |
| confidence | string | yes |  |  |
| revision | integer | yes |  |  |
| ingested_at | date | yes |  |  |
| value_new | number | no |  |  |
| value_stock | number | no |  |  |
| rebase_flag | integer | no |  |  |
| first_observation | integer | no |  |  |
| delta_negative_clamped | integer | no |  |  |

## staging.reliefweb_pdf

ReliefWeb PDF staging output with attachment metadata.

| Name | Type | Required | Enum/Format | Description |
| --- | --- | --- | --- | --- |
| extraction_layer | string | no |  |  |
| matched_phrase | string | no |  |  |
| method_details | string | no |  |  |
| method_value | string | no |  |  |
| month_start | string | no |  |  |
| resource_url | string | no |  |  |
| tier | string | no |  |  |
| value_level | number | no |  |  |

## staging.unhcr_odp

UNHCR Operational Data Portal staging output.

| Name | Type | Required | Enum/Format | Description |
| --- | --- | --- | --- | --- |
| source | string | yes |  |  |
| source_event_id | string | yes |  |  |
| as_of_date | date | yes |  |  |
| country_iso3 | string | yes |  |  |
| country_name | string | yes |  |  |
| hazard_code | string | yes |  |  |
| hazard_label | string | yes |  |  |
| hazard_class | string | yes |  |  |
| metric_name | string | yes |  |  |
| metric_unit | string | yes |  |  |
| series_semantics | enum | no | stock, new |  |
| value | number | yes |  |  |
| evidence_url | string | yes |  |  |
| evidence_label | string | yes |  |  |

## staging.worldpop

WorldPop denominators staging output.

| Name | Type | Required | Enum/Format | Description |
| --- | --- | --- | --- | --- |
| iso3 | string | yes |  |  |
| year | integer | yes |  |  |
| population | number | yes |  |  |
| source | string | yes |  |  |
| product | string | yes |  |  |
| download_date | date | yes |  |  |
| source_url | string | yes |  |  |
| notes | string | no |  |  |

## staging.dtm_displacement

Monthly displacement flows generated from the DTM connector.

| Name | Type | Required | Enum/Format | Description |
| --- | --- | --- | --- | --- |
| source | string | yes |  | Constant `dtm`. |
| country_iso3 | string | yes |  | ISO3 country code. |
| admin1 | string | no |  | First-level administrative name (blank for admin0 rollup). |
| event_id | string | yes |  | Deterministic hash of country/admin/month. |
| as_of | timestamp | yes |  | Timestamp of latest reporting for the month. |
| month_start | date | yes |  | Month bucket in `YYYY-MM-01`. |
| value_type | enum | yes | new_displaced | Semantic for the displacement value. |
| value | integer | yes |  | Monthly new displaced people (can be negative for returns). |
| unit | enum | yes | people | Unit of measure. |
| method | enum | yes | dtm_stock_to_flow | Transformation applied to convert stock to flow. |
| confidence | enum | yes | low, medium, high | Analyst confidence score (defaults to `medium`). |
| raw_event_id | string | yes |  | Source identifier if present. |
| raw_fields_json | string | yes |  | Compact JSON snapshot of key API fields. |

Example rows:

| source | country_iso3 | admin1 | event_id | as_of | month_start | value_type | value | unit | method | confidence | raw_event_id |
| --- | --- | --- | --- | --- | --- | --- | --- | --- | --- | --- | --- |
| dtm | COL | Antioquia | 7c1e6ad5d2f4c3a1 | 2024-02-15T00:00:00Z | 2024-02-01 | new_displaced | 400 | people | dtm_stock_to_flow | medium | offline:COL:Antioquia:2024-02-01 |
| dtm | COL |  | 5f6c9721bf93d8a0 | 2024-02-20T00:00:00Z | 2024-02-01 | new_displaced | 750 | people | dtm_stock_to_flow | medium | 5f6c9721bf93d8a0 |

Canonical CSV header (mirrors `resolver.ingestion.dtm_client.CANONICAL_HEADERS`):

```
source,country_iso3,admin1,event_id,as_of,month_start,value_type,value,unit,method,confidence,raw_event_id,raw_fields_json
```

> **Resilience note:** When `resolver.ingestion.dtm_client` is invoked with soft timeouts enabled and `dtmapi.iom.int` is
> temporarily unreachable, the connector writes only the header row plus a `.meta.json` stub (recording `status: "ok"` and
> `zero_rows_reason: "connect_timeout"`). Downstream export tools already treat empty CSVs as “no new displacement data” and
> must continue to accept header-only inputs in those scenarios.

## db.facts_raw

Canonical facts written to DuckDB alongside CSV exports.

| Name | Type | Required | Enum/Format | Description |
| --- | --- | --- | --- | --- |
| event_id | string | yes |  |  |
| country_name | string | yes |  |  |
| iso3 | string | yes |  |  |
| hazard_code | string | yes |  |  |
| hazard_label | string | yes |  |  |
| hazard_class | string | yes |  |  |
| metric | enum | yes | in_need, affected, displaced, cases, fatalities<br>events, participants |  |
| series_semantics | enum | no | stock, new |  |
| value | number | yes |  |  |
| unit | enum | yes | persons, persons_cases, events |  |
| as_of_date | string | yes |  | ISO-8601 date (YYYY-MM-DD) |
| publication_date | string | yes |  | ISO-8601 date (YYYY-MM-DD) |
| publisher | string | yes |  |  |
| source_type | string | yes |  |  |
| source_url | string | no |  |  |
| doc_title | string | yes |  |  |
| definition_text | string | yes |  |  |
| method | string | yes |  |  |
| confidence | string | yes |  |  |
| revision | integer | yes |  |  |
| ingested_at | date | yes |  |  |
| value_new | number | no |  |  |
| value_stock | number | no |  |  |
| rebase_flag | integer | no |  |  |
| first_observation | integer | no |  |  |
| delta_negative_clamped | integer | no |  |  |
| created_at | datetime | no |  |  |

## db.facts_resolved

Resolved precedence outputs stored in DuckDB for querying.

| Name | Type | Required | Enum/Format | Description |
| --- | --- | --- | --- | --- |
| ym | string | yes |  |  |
| iso3 | string | yes |  |  |
| hazard_code | string | yes |  |  |
| hazard_label | string | yes |  |  |
| hazard_class | string | yes |  |  |
| metric | enum | yes | in_need, affected, displaced, cases, fatalities<br>events, participants |  |
| series_semantics | enum | no | stock, new |  |
| value | number | yes |  |  |
| unit | enum | yes | persons, persons_cases, events |  |
| as_of_date | string | yes |  | ISO-8601 date (YYYY-MM-DD) |
| publication_date | string | yes |  | ISO-8601 date (YYYY-MM-DD) |
| publisher | string | yes |  |  |
| source_type | string | no |  |  |
| source_url | string | no |  |  |
| doc_title | string | no |  |  |
| definition_text | string | no |  |  |
| precedence_tier | string | no |  |  |
| event_id | string | no |  |  |
| proxy_for | string | no |  |  |
| confidence | string | no |  |  |
| created_at | datetime | no |  |  |

## db.facts_deltas

Monthly "new" deltas derived from resolved totals.

| Name | Type | Required | Enum/Format | Description |
| --- | --- | --- | --- | --- |
| ym | string | yes |  |  |
| iso3 | string | yes |  |  |
| hazard_code | string | yes |  |  |
| metric | enum | yes | in_need, affected, displaced, cases, fatalities<br>events, participants |  |
| value_new | number | yes |  |  |
| value_stock | number | no |  |  |
| series_semantics | enum | no | new |  |
| rebase_flag | integer | no |  |  |
| first_observation | integer | no |  |  |
| delta_negative_clamped | integer | no |  |  |
| as_of | string | yes |  | ISO-8601 date (YYYY-MM-DD) |
| source_name | string | yes |  |  |
| source_url | string | no |  |  |
| definition_text | string | no |  |  |
| created_at | datetime | no |  |  |

### Metric reference

| Metric | Series semantics | Unit | Cadence | Description |
| --- | --- | --- | --- | --- |
| idp_displacement_new_dtm | new | persons | monthly | Monthly new internally displaced persons derived from DTM admin0 stock snapshots. Semantics `new` denotes the month-over-month increase computed from `value_type=new_displaced` rows produced by the connector. |

## db.snapshots

Snapshot metadata recorded alongside dual-write operations.

| Name | Type | Required | Enum/Format | Description |
| --- | --- | --- | --- | --- |
| ym | string | yes |  |  |
| created_at | datetime | yes |  |  |
| git_sha | string | no |  |  |
| export_version | string | no |  |  |
| facts_rows | integer | no |  |  |
| deltas_rows | integer | no |  |  |
| meta | string | no |  |  |

## db.manifests

Snapshot manifest entries mirroring CSV exports.

| Name | Type | Required | Enum/Format | Description |
| --- | --- | --- | --- | --- |
| ym | string | yes |  |  |
| name | string | yes |  |  |
| path | string | no |  |  |
| rows | integer | no |  |  |
| checksum | string | no |  |  |
| payload | string | no |  |  |
| created_at | datetime | no |  |  |

## context.facts_last12

LLM context bundle summarising monthly new-series PIN/PA totals.

Column order is canonical: `iso3`, `hazard_code`, `ym`, `metric`, `unit`, `value`, `series`. The builder returns an empty DataFrame with these columns when no months are available so downstream consumers can rely on the schema.

| Name | Type | Required | Enum/Format | Description |
| --- | --- | --- | --- | --- |
| iso3 | string | yes |  |  |
| hazard_code | string | yes |  |  |
| ym | string | yes |  | Year-month bucket (YYYY-MM) |
| metric | enum | yes | in_need, affected |  |
| unit | string | yes |  | Measurement unit (`persons` rows are rounded to whole numbers) |
| value | number | yes |  | Numeric total per month/metric |
| series | enum | yes | new |  |

## Ingestion Diagnostics Schema

Structured JSONL lines emitted by `resolver/ingestion/run_all_stubs.py` and summarised by `scripts/ci/summarize_connectors.py`.

| Field | Type | Required | Description |
| --- | --- | --- | --- |
| connector_id | string | yes | Canonical connector identifier (e.g. `acled_client`). |
| mode | enum | yes | `real` or `stub`. |
| status | enum | yes | `ok`, `skipped`, or `error`. |
| reason | string | no | Normalised skip/failure reason (for example `disabled: config`, `missing secret ACLED_TOKEN`, `upstream-502`). |
| started_at_utc | string | yes | ISO-8601 UTC timestamp of the attempt start. |
| duration_ms | integer | yes | Total runtime in milliseconds. |
| http | object | yes | HTTP telemetry with keys `2xx`, `4xx`, `5xx`, `retries`, `rate_limit_remaining`, and `last_status`. |
| counts | object | yes | Row totals with keys `fetched`, `normalized`, and `written`. |
| coverage | object | yes | Time-window coverage: `ym_min`, `ym_max`, `as_of_min`, `as_of_max` (nullable). |
| samples | object | yes | Top samples (arrays of `[value, count]`) under `top_iso3` and `top_hazard`. |
| extras | object | no | Connector-specific metadata (for example `rows_method`, `rows_before`, `rows_written`). Sensitive values are redacted to `***`. |

Example JSONL entry:

```json
{
  "connector_id": "acled_client",
  "mode": "real",
  "status": "ok",
  "reason": null,
  "started_at_utc": "2024-02-01T02:04:12Z",
  "duration_ms": 182345,
  "http": {"2xx": 42, "4xx": 0, "5xx": 0, "retries": 1, "rate_limit_remaining": 75, "last_status": 200},
  "counts": {"fetched": 520, "normalized": 515, "written": 510},
  "coverage": {"ym_min": "2023-12", "ym_max": "2024-01", "as_of_min": "2024-01-05", "as_of_max": "2024-01-31"},
  "samples": {"top_iso3": [["KEN", 120], ["UGA", 95]], "top_hazard": [["conflict", 140]]},
  "extras": {"rows_method": "manifest", "rows_before": 0, "rows_written": 510}
}
```

## IDMC connector configuration keys

The IDMC connector reads `resolver/ingestion/config/idmc.yml` and accepts the following
structured overrides (all mirrored by environment variables):

- `api.base_url` and `api.endpoints` (including `idus_json` and `idus_geo`) control the IDU
  HTTP targets; override via `IDMC_BASE_URL`.
- `cache.dir`, `cache.ttl_seconds`, and `cache.force_cache_only` configure the on-disk cache;
  override via `IDMC_CACHE_DIR`, `IDMC_CACHE_TTL_S`, and `IDMC_FORCE_CACHE_ONLY`.
- `api.token_env` (default `IDMC_API_TOKEN`) names the optional bearer token environment
  variable attached to HTTP requests.
- Normalization and diagnostics semantics are documented in
  `resolver/docs/ingestion/idmc.md`.

## DTM API diagnostics

The DTM connector is API-only and always calls the official DTM API via the `dtmapi` package.

**Secrets:**
- `DTM_API_KEY` (required) — single IOM DTM subscription key used for all authenticated calls.

Normalization for the admin0 staging feed lives in `resolver/ingestion/dtm/normalize.py`. The
diagnostics payload emitted under `extras.normalize` records
`chosen_value_columns` counts before any ISO/date filtering and increments the
`drop_reasons` buckets (`no_iso3`, `no_value_col`, `date_out_of_window`,
`date_parse_failed`, `other`) at the moment each row is discarded.

**Configuration fields:**

| Field | Required | Description |
| --- | --- | --- |
| `api.admin_levels` | no | Levels to fetch (`admin0`, `admin1`, `admin2`). Defaults to `admin0`. |
| `api.countries` | no | Optional list of ISO3 codes or country names. When provided the connector skips discovery and uses the explicit list in order. |
| `api.operations` | no | Operation names for admin2 pulls. |
| `api.discovery_order` | no | Discovery strategy order. Defaults to `[countries, operations, static_iso3]`. |
| `api.timeouts` | no | HTTP connect/read timeouts in seconds. Defaults to `5` connect / `30` read. |
| `api.retries` | no | Retry attempts/backoff seconds. Defaults to `3` attempts, `1.5` seconds. |
| `field_mapping` | no | Overrides for API column names (rarely needed). |
| `field_aliases.idp_count` | no | Candidate columns containing the IDP total. |
| `output.measure` | no | `stock` (default) converts cumulative totals to flows; `flow` keeps month deltas. |

**Example configuration:**
```yaml
enabled: true
api:
  countries: []
  admin_levels: [admin0]
  operations: []
  indicators: ["idps"]
  discovery_order: ["countries", "operations", "static_iso3"]
  timeouts:
    connect_seconds: 5
    read_seconds: 30
  retries:
    attempts: 3
    backoff_seconds: 1.5
output:
  measure: stock
field_aliases:
  idp_count: ["TotalIDPs", "IDPTotal"]
```

**Ingestion diagnostics scaffolding:** every workflow run publishes the shared artifacts:
- `diagnostics/ingestion/summary.md` — Markdown dashboard rendered from connector telemetry.
- `diagnostics/ingestion/connectors_report.jsonl` — machine-readable ledger of connector outcomes.
- `diagnostics/ingestion/logs/` — per-connector log files (always present, `.keep` seeded when empty).
- `diagnostics/ingestion/raw/` — raw payloads collected during connector execution.
- `diagnostics/ingestion/metrics/` — numeric rollups or per-request metrics emitted by connectors.
- `diagnostics/ingestion/samples/` — sampled rows preserved for schema inspection.
- `diagnostics/ingestion/dtm/` — discovery probes and HTTP traces from the DTM client, including `discovery_fail.json` when discovery fails.

> **Heads-up:** CI (including the Codex Canary Gate) often runs with network access disabled. When upstream APIs are unreachable the connector writes header-only staging CSVs plus metadata that captures `zero_rows_reason="connect_timeout"`. Downstream exporters and schema checks must treat these empty-but-successful outputs as valid.

> **CI note:** Connector automation may add safety flags such as `--soft-timeouts` or `--no-date-filter` on behalf of Codex workflows. The runner intentionally inserts those before any user-provided extras so test expectations that "last flag wins" remain stable.

**Diagnostics:** each execution writes:
- `diagnostics/ingestion/dtm_run.json` summarising the ingestion window, requested and resolved countries, HTTP counters (`2xx`, `4xx`, `5xx`, `timeout`, `error`, `retries`, `last_status`), paging (`pages`, `page_size`, `total_received`), row totals, and a `totals` block capturing aggregate counts plus the CLI arguments used.
- `diagnostics/ingestion/dtm_api_request.json` recording admin levels, countries, operations, and the date window passed to the API (secrets redacted).
- `diagnostics/ingestion/dtm_api_sample.json` (and the legacy `dtm_api_response_sample.json`) containing up to 100 standardized rows.
- `diagnostics/ingestion/raw/dtm/<level>.<country>.head.csv` snapshots of the first successful fetch per level (up to 100 rows) for quick schema inspection.
- `diagnostics/ingestion/raw/dtm_countries.json` — JSON dump of the discovery payload returned by `DTMApi.get_all_countries()`.
- `diagnostics/ingestion/metrics/dtm_per_country.jsonl` — JSONL ledger with per-country/per-level row counts and elapsed timings for each request.
- `diagnostics/ingestion/samples/dtm_sample.csv` — up to 200 normalized rows across all countries and admin levels.
- `diagnostics/ingestion/logs/dtm_client.log` — enriched connector log including masked key suffix, window, country counts, per-level totals, and retry snapshots.
- `diagnostics/ingestion/dtm/discovery_countries.csv` — snapshot of the selectors used for the run (SDK payload when discovery succeeds, or the explicit/static roster used as fallback).
- `diagnostics/ingestion/dtm/dtm_http.ndjson` — per-request ledger including `level`, `country`, optional `operation`, elapsed time, row count, and status (`ok`, `empty`, `error`).
- `diagnostics/ingestion/dtm/sample_<level>.csv` — 50-row samples of the first non-empty response per admin level for schema reference.
- `diagnostics/ingestion/dtm/discovery_fail.json` — always written; records `stages` (per-discovery attempt status, latency, and row counts), `errors` (any exception details), `attempts` (by stage), `latency_ms`, and `used_stage` (`explicit_list`, `countries`, `operations`, or `static_iso3`). A static ISO-3 roster ships with the connector and is used when both HTTP discovery stages fail.
- `diagnostics/ingestion/metrics/metrics.json` — summary payload with `countries_attempted`, `countries_ok`, `countries_skipped_no_match`, `countries_failed_other`, `rows_fetched`, `duration_sec`, and `stage_used` for each run (updated even on failure).
- `diagnostics/ingestion/samples/sample_admin0.csv` — per-run CSV with headers and up to five Admin0 samples; always present so CI uploads succeed even when discovery fails.

The static fallback roster lives at `resolver/ingestion/static/iso3_master.csv` and contains exactly two UTF-8 columns (`admin0Pcode`, `admin0Name`). Country names containing commas **must** be quoted (RFC 4180) so pandas can read the file without ambiguity. The helper `resolver/ingestion/static/iso3_master.validate.py` can be invoked locally or in CI to sanity-check edits.

**Output metadata:**
- `data/staging/dtm_displacement.csv` is always emitted with headers even when zero rows were written (for example, soft timeouts or explicit skip modes). The companion `data/staging/dtm_displacement.csv.meta.json` captures the CSV row count, resolved ingestion window, the dependency snapshot (`deps` with `python`, `executable`, `dtmapi`, `pandas`, `requests`), effective query parameters (`effective_params` with `from`, `to`, `admin_levels`, `country_mode`, `discovered_countries_count`, `idp_aliases`, paging stats, and country echoes), HTTP counters (`http_counters`), timing information (`timings_ms`), a per-country row breakdown (`per_country_counts`), any per-country failures recorded during the run (`failures`), a `discovery` object (`total_countries`, `sdk_version`, `api_base`, `discovery_file`, `source`), a `diagnostics` object (`http_trace`, `samples`, `raw_countries`, `metrics`, `sample`, `log`, `no_data_combos`), plus top-level `status`, `reason`, `zero_rows_reason` (when applicable), and a condensed HTTP summary under `http` (including timeout counters).
- `diagnostics/ingestion/dtm_run.json` now has the shape:

```jsonc
{
  "window": {"start": "2024-01-01", "end": "2024-02-01"},
  "countries": {"requested": ["KEN"], "resolved": ["Kenya"]},
  "http": {"2xx": 3, "4xx": 0, "5xx": 0, "timeout": 0, "error": 0, "retries": 0, "rate_limit_remaining": null, "last_status": 200},
  "paging": {"pages": 3, "page_size": 500, "total_received": 1200},
  "rows": {"fetched": 1200, "normalized": 1180, "written": 1180, "kept": 1180, "dropped": 20},
  "totals": {
    "rows_fetched": 1200,
    "rows_normalized": 1180,
    "rows_written": 1180,
    "kept": 1180,
    "dropped": 20,
    "parse_errors": 0
  },
  "status": "ok",
  "reason": "wrote 1180 rows",
  "outputs": {"csv": "data/staging/dtm_displacement.csv", "meta": "data/staging/dtm_displacement.csv.meta.json"},
  "extras": {
    "api_sample_path": "diagnostics/ingestion/dtm_api_sample.json",
    "deps": {
      "python": "3.11.9",
      "executable": "/usr/bin/python3",
      "dtmapi": "0.1.5",
      "pandas": "2.1.4",
      "requests": "2.31.0"
    },
    "effective_params": {
      "resource": "dtmapi",
      "from": "2024-01-01",
      "to": "2024-02-01",
      "admin_levels": ["admin0", "admin1"],
      "operations": null,
      "country_mode": "ALL",
      "discovered_countries_count": 45,
      "countries_requested": [],
      "countries": ["Kenya", "Uganda"],
      "idp_aliases": ["TotalIDPs", "IDPTotal", "numPresentIdpInd"],
      "no_date_filter": false,
      "per_page": 500,
      "max_pages": 3
    },
    "discovery": {
      "total_countries": 45,
      "sdk_version": "0.1.5",
      "api_base": "https://dtmapi.iom.int",
      "discovery_file": "diagnostics/ingestion/dtm/discovery_countries.csv",
      "source": "countries"
    },
    "diagnostics": {
      "requests_log": "diagnostics/ingestion/dtm/requests.jsonl",
      "samples": ["diagnostics/ingestion/dtm/sample_admin0.csv", "diagnostics/ingestion/dtm/sample_admin1.csv"]
    },
    "per_country_counts": [
      {"country": "Kenya", "level": "admin0", "rows": 1180, "window": "2024-01-01->2024-02-01"}
    ],
    "failures": [],
    "timings_ms": {"preflight": 45, "fetch_total": 1234, "normalize": 210, "write": 80}
  },
  "args": {"strict_empty": false, "no_date_filter": false}
}
```

The connectors report (`diagnostics/ingestion/connectors_report.jsonl`) mirrors these
values and now surfaces additional normalization telemetry:

- `extras.normalize.drop_reasons` — counts per drop category (`no_iso3`,
  `no_value_col`, `date_out_of_window`, `no_country_match`, `other`).
- `extras.normalize.chosen_value_columns` — list of the IDP value columns used,
  including the number of non-null observations per column, ordered by
  frequency. This makes it clear when normalization fails because no value
  column matched or when unexpected ISO3 values cause records to be dropped.

**Exit codes:**

| Exit code | Status | Description |
| --- | --- | --- |
| `0` | `ok` | Successful run with at least one row written. |
| `0` | `ok-empty` | Successful run with zero rows (header-only output). |
| `3` | `ok-empty` | Zero rows with `--strict-empty`/`DTM_STRICT_EMPTY=1`. |
| `2` | `error` | Configuration or authentication failure (missing key, invalid config). |
| `1` | `error` | Runtime exception (network failure, unexpected API error). |
| `skipped` | `skipped` | `RESOLVER_SKIP_DTM=1` or connector disabled in config. |

Zero-row runs are marked `ok-empty` with reason `"header-only (0 rows)"`; `dtm_api_sample.json` captures the API response sample to help diagnose the cause.
- **Note:** The ingestion window is derived from `BACKFILL_START_ISO` and `BACKFILL_END_ISO`. If either discovery returns zero countries or every request yields zero rows within that window the connector raises a `RuntimeError`, surfaces the reason in `dtm_run.json`, and exits with a non-zero status.

## Export configuration (`resolver/tools/export_config.yml`)

`export_facts.py` reads this YAML to map staging files into canonical `facts.csv` rows. Each entry under
`sources` contains:

| Key | Required | Description |
| --- | --- | --- |
| `name` | yes | Identifier for logs and diagnostics. |
| `match.filename_regex` | no | Case-insensitive regex applied to the filename; when omitted any file may match. |
| `match.required_columns` | no | List of source columns that must exist for the mapping to apply. |
| `match.required_any` | no | Map canonical fields to alias lists; require at least one column per alias group. |
| `map.<target>.from` | no | Source column (or previously-derived target) to transform into the canonical column. |
| `map.<target>.from_any` | no | Ordered list of candidate columns/targets to try; the first available value is used. |
| `map.<target>.const` | no | Constant value used when no source column is required. |
| `map.<target>.ops` | no | Ordered list of operations applied to the series (see below). |
| `filters.keep_if_not_null` | no | Drop rows where any listed column is blank or null after mapping. |
| `filters.keep_if_positive` | no | Drop rows where any listed column is ≤ 0 after numeric coercion. |
| `aggregate.keys` | no | Columns to group by before deduplication (e.g., `iso3`, `as_of_date`, `metric`). |
| `aggregate.funcs` | no | Aggregation applied per column within each group (e.g., `value: max`). |
| `dedupe.keys` | no | Columns used for row-level deduplication (e.g., `iso3`, `as_of_date`, `metric`). |
| `dedupe.keep` | no | `first` or `last` row to keep during deduplication (defaults to `last`). |

Supported `ops` values:

- `trim` / `strip` — remove leading/trailing whitespace.
- `uppercase` / `lowercase` — enforce casing.
- `to_date` — parse timestamps into `YYYY-MM-DD` strings.
- `to_ym` — derive `YYYY-MM` from a date-like column.
- `to_number` — coerce values into numeric strings (dropping non-numeric rows when paired with `keep_if_positive`).

The exporter groups rows via the optional `aggregate` block before deduplication, letting mappings
collapse duplicates deterministically (for example, keeping the monthly maximum stock figure per
`iso3`/`as_of_date`/`metric`). When no configured source matches a file, the exporter auto-detects
DTM displacement CSVs that expose `CountryISO3`, `ReportingDate`, and `idp_count` columns and
applies the same mapping as `dtm_displacement_admin0`. Files that already provide every canonical
column fall back to a pass-through mapping.

### Export report artifacts

Successful runs emit lightweight diagnostics alongside `facts.csv` in the export directory **and**
append the same Markdown block to `diagnostics/ingestion/summary.md` (and `GITHUB_STEP_SUMMARY`
when running inside Actions):

- `export_report.json` — machine-readable metadata with:
  - `inputs_scanned`: total number of files inspected under the `--in` path (metadata included).
  - `matched_files`: objects containing `path`, `source`, `strategy`, `rows_in`,
    `rows_after_filters`, `rows_after_aggregate`, `rows_after_dedupe`, per-source mapping details,
    and any rule-level drop histogram or warnings.
  - `unmatched_files`: files that were discovered but produced no rows (unmapped, empty, or read
    failures).
  - `rows_exported`: final row count written to `facts.csv`.
  - `filters_applied`: ordered list of filter rule names that ran.
  - `dedupe_keys` / `dedupe_keep`: columns and strategy (`first`/`last`) used during deduplication.
  - `dropped_by_filter`: histogram of rows removed by each filter rule.
  - `preview`: first five exported rows serialized as dictionaries for quick inspection.
  - `warnings`: de-duplicated warning strings surfaced during mapping.
  - `meta_files_skipped`: metadata companions (`*.meta.json`) ignored during the run.
- `monthly_summary`: per-month row counts across the exported facts (based on `as_of_date`).
- `export_report.md` — Markdown rendering of the same payload with bullet highlights, a matched-file
  table, mapping/aggregation annotations, a monthly summary, and a four-column preview (iso3,
  as_of_date, metric, value) of the exported facts.

Empty or invalid inputs no longer halt the export; instead they surface warnings, appear under
`unmatched_files`, and allow remaining files to map successfully.
