<!--- DO NOT EDIT: generated by resolver/tools/generate_schemas_md.py on 2025-10-22Z -->

# Resolver Schemas

## Table of contents

- [staging.common](#stagingcommon)
- [staging.reliefweb_pdf](#stagingreliefwebpdf)
- [staging.unhcr_odp](#stagingunhcrodp)
- [staging.worldpop](#stagingworldpop)
- [db.facts_raw](#dbfactsraw)
- [db.facts_resolved](#dbfactsresolved)
- [db.facts_deltas](#dbfactsdeltas)
- [db.snapshots](#dbsnapshots)
- [db.manifests](#dbmanifests)
- [context.facts_last12](#contextfacts_last12)
- [Ingestion Diagnostics Schema](#ingestion-diagnostics-schema)

## staging.common

Canonical staging columns for event-centric connectors.

| Name | Type | Required | Enum/Format | Description |
| --- | --- | --- | --- | --- |
| event_id | string | yes |  |  |
| country_name | string | yes |  |  |
| iso3 | string | yes |  |  |
| hazard_code | string | yes |  |  |
| hazard_label | string | yes |  |  |
| hazard_class | string | yes |  |  |
| metric | enum | yes | in_need, affected, displaced, cases, fatalities<br>events, participants |  |
| series_semantics | enum | no | stock, new |  |
| value | number | yes |  |  |
| unit | enum | yes | persons, persons_cases, events |  |
| as_of_date | string | yes |  | ISO-8601 date (YYYY-MM-DD) |
| publication_date | string | yes |  | ISO-8601 date (YYYY-MM-DD) |
| publisher | string | yes |  |  |
| source_type | string | yes |  |  |
| source_url | string | yes |  |  |
| doc_title | string | yes |  |  |
| definition_text | string | yes |  |  |
| method | string | yes |  |  |
| confidence | string | yes |  |  |
| revision | integer | yes |  |  |
| ingested_at | date | yes |  |  |
| value_new | number | no |  |  |
| value_stock | number | no |  |  |
| rebase_flag | integer | no |  |  |
| first_observation | integer | no |  |  |
| delta_negative_clamped | integer | no |  |  |

## staging.reliefweb_pdf

ReliefWeb PDF staging output with attachment metadata.

| Name | Type | Required | Enum/Format | Description |
| --- | --- | --- | --- | --- |
| extraction_layer | string | no |  |  |
| matched_phrase | string | no |  |  |
| method_details | string | no |  |  |
| method_value | string | no |  |  |
| month_start | string | no |  |  |
| resource_url | string | no |  |  |
| tier | string | no |  |  |
| value_level | number | no |  |  |

## staging.unhcr_odp

UNHCR Operational Data Portal staging output.

| Name | Type | Required | Enum/Format | Description |
| --- | --- | --- | --- | --- |
| source | string | yes |  |  |
| source_event_id | string | yes |  |  |
| as_of_date | date | yes |  |  |
| country_iso3 | string | yes |  |  |
| country_name | string | yes |  |  |
| hazard_code | string | yes |  |  |
| hazard_label | string | yes |  |  |
| hazard_class | string | yes |  |  |
| metric_name | string | yes |  |  |
| metric_unit | string | yes |  |  |
| series_semantics | enum | no | stock, new |  |
| value | number | yes |  |  |
| evidence_url | string | yes |  |  |
| evidence_label | string | yes |  |  |

## staging.worldpop

WorldPop denominators staging output.

| Name | Type | Required | Enum/Format | Description |
| --- | --- | --- | --- | --- |
| iso3 | string | yes |  |  |
| year | integer | yes |  |  |
| population | number | yes |  |  |
| source | string | yes |  |  |
| product | string | yes |  |  |
| download_date | date | yes |  |  |
| source_url | string | yes |  |  |
| notes | string | no |  |  |

## db.facts_raw

Canonical facts written to DuckDB alongside CSV exports.

| Name | Type | Required | Enum/Format | Description |
| --- | --- | --- | --- | --- |
| event_id | string | yes |  |  |
| country_name | string | yes |  |  |
| iso3 | string | yes |  |  |
| hazard_code | string | yes |  |  |
| hazard_label | string | yes |  |  |
| hazard_class | string | yes |  |  |
| metric | enum | yes | in_need, affected, displaced, cases, fatalities<br>events, participants |  |
| series_semantics | enum | no | stock, new |  |
| value | number | yes |  |  |
| unit | enum | yes | persons, persons_cases, events |  |
| as_of_date | string | yes |  | ISO-8601 date (YYYY-MM-DD) |
| publication_date | string | yes |  | ISO-8601 date (YYYY-MM-DD) |
| publisher | string | yes |  |  |
| source_type | string | yes |  |  |
| source_url | string | no |  |  |
| doc_title | string | yes |  |  |
| definition_text | string | yes |  |  |
| method | string | yes |  |  |
| confidence | string | yes |  |  |
| revision | integer | yes |  |  |
| ingested_at | date | yes |  |  |
| value_new | number | no |  |  |
| value_stock | number | no |  |  |
| rebase_flag | integer | no |  |  |
| first_observation | integer | no |  |  |
| delta_negative_clamped | integer | no |  |  |
| created_at | datetime | no |  |  |

## db.facts_resolved

Resolved precedence outputs stored in DuckDB for querying.

| Name | Type | Required | Enum/Format | Description |
| --- | --- | --- | --- | --- |
| ym | string | yes |  |  |
| iso3 | string | yes |  |  |
| hazard_code | string | yes |  |  |
| hazard_label | string | yes |  |  |
| hazard_class | string | yes |  |  |
| metric | enum | yes | in_need, affected, displaced, cases, fatalities<br>events, participants |  |
| series_semantics | enum | no | stock, new |  |
| value | number | yes |  |  |
| unit | enum | yes | persons, persons_cases, events |  |
| as_of_date | string | yes |  | ISO-8601 date (YYYY-MM-DD) |
| publication_date | string | yes |  | ISO-8601 date (YYYY-MM-DD) |
| publisher | string | yes |  |  |
| source_type | string | no |  |  |
| source_url | string | no |  |  |
| doc_title | string | no |  |  |
| definition_text | string | no |  |  |
| precedence_tier | string | no |  |  |
| event_id | string | no |  |  |
| proxy_for | string | no |  |  |
| confidence | string | no |  |  |
| created_at | datetime | no |  |  |

## db.facts_deltas

Monthly "new" deltas derived from resolved totals.

| Name | Type | Required | Enum/Format | Description |
| --- | --- | --- | --- | --- |
| ym | string | yes |  |  |
| iso3 | string | yes |  |  |
| hazard_code | string | yes |  |  |
| metric | enum | yes | in_need, affected, displaced, cases, fatalities<br>events, participants |  |
| value_new | number | yes |  |  |
| value_stock | number | no |  |  |
| series_semantics | enum | no | new |  |
| rebase_flag | integer | no |  |  |
| first_observation | integer | no |  |  |
| delta_negative_clamped | integer | no |  |  |
| as_of | string | yes |  | ISO-8601 date (YYYY-MM-DD) |
| source_name | string | yes |  |  |
| source_url | string | no |  |  |
| definition_text | string | no |  |  |
| created_at | datetime | no |  |  |

## db.snapshots

Snapshot metadata recorded alongside dual-write operations.

| Name | Type | Required | Enum/Format | Description |
| --- | --- | --- | --- | --- |
| ym | string | yes |  |  |
| created_at | datetime | yes |  |  |
| git_sha | string | no |  |  |
| export_version | string | no |  |  |
| facts_rows | integer | no |  |  |
| deltas_rows | integer | no |  |  |
| meta | string | no |  |  |

## db.manifests

Snapshot manifest entries mirroring CSV exports.

| Name | Type | Required | Enum/Format | Description |
| --- | --- | --- | --- | --- |
| ym | string | yes |  |  |
| name | string | yes |  |  |
| path | string | no |  |  |
| rows | integer | no |  |  |
| checksum | string | no |  |  |
| payload | string | no |  |  |
| created_at | datetime | no |  |  |

## context.facts_last12

LLM context bundle summarising monthly new-series PIN/PA totals.

Column order is canonical: `iso3`, `hazard_code`, `ym`, `metric`, `unit`, `value`, `series`. The builder returns an empty DataFrame with these columns when no months are available so downstream consumers can rely on the schema.

| Name | Type | Required | Enum/Format | Description |
| --- | --- | --- | --- | --- |
| iso3 | string | yes |  |  |
| hazard_code | string | yes |  |  |
| ym | string | yes |  | Year-month bucket (YYYY-MM) |
| metric | enum | yes | in_need, affected |  |
| unit | string | yes |  | Measurement unit (`persons` rows are rounded to whole numbers) |
| value | number | yes |  | Numeric total per month/metric |
| series | enum | yes | new |  |

## Ingestion Diagnostics Schema

Structured JSONL lines emitted by `resolver/ingestion/run_all_stubs.py` and summarised by `scripts/ci/summarize_connectors.py`.

| Field | Type | Required | Description |
| --- | --- | --- | --- |
| connector_id | string | yes | Canonical connector identifier (e.g. `acled_client`). |
| mode | enum | yes | `real` or `stub`. |
| status | enum | yes | `ok`, `skipped`, or `error`. |
| reason | string | no | Normalised skip/failure reason (for example `disabled: config`, `missing secret ACLED_TOKEN`, `upstream-502`). |
| started_at_utc | string | yes | ISO-8601 UTC timestamp of the attempt start. |
| duration_ms | integer | yes | Total runtime in milliseconds. |
| http | object | yes | HTTP telemetry with keys `2xx`, `4xx`, `5xx`, `retries`, `rate_limit_remaining`, and `last_status`. |
| counts | object | yes | Row totals with keys `fetched`, `normalized`, and `written`. |
| coverage | object | yes | Time-window coverage: `ym_min`, `ym_max`, `as_of_min`, `as_of_max` (nullable). |
| samples | object | yes | Top samples (arrays of `[value, count]`) under `top_iso3` and `top_hazard`. |
| extras | object | no | Connector-specific metadata (for example `rows_method`, `rows_before`, `rows_written`). Sensitive values are redacted to `***`. |

Example JSONL entry:

```json
{
  "connector_id": "acled_client",
  "mode": "real",
  "status": "ok",
  "reason": null,
  "started_at_utc": "2024-02-01T02:04:12Z",
  "duration_ms": 182345,
  "http": {"2xx": 42, "4xx": 0, "5xx": 0, "retries": 1, "rate_limit_remaining": 75, "last_status": 200},
  "counts": {"fetched": 520, "normalized": 515, "written": 510},
  "coverage": {"ym_min": "2023-12", "ym_max": "2024-01", "as_of_min": "2024-01-05", "as_of_max": "2024-01-31"},
  "samples": {"top_iso3": [["KEN", 120], ["UGA", 95]], "top_hazard": [["conflict", 140]]},
  "extras": {"rows_method": "manifest", "rows_before": 0, "rows_written": 510}
}
```

## DTM source configuration

The DTM connector is API-only and always calls the official DTM API v3 via the `dtmapi` package.

**Requirements:**
- `DTM_API_KEY` environment variable (primary subscription key). The connector aborts if the key is missing.
- Optional `DTM_API_SECONDARY_KEY` environment variable. When present the connector retries with the secondary key on 401/403 responses.

**Configuration fields:**

| Field | Required | Description |
| --- | --- | --- |
| `api.admin_levels` | no | List of admin levels to fetch: `admin0`, `admin1`, `admin2` (default: all three). |
| `api.countries` | no | List of country names; use an empty list to fetch all available countries. |
| `api.operations` | no | List of operation names, primarily for admin2 pulls. |
| `field_mapping` | no | Maps API response field names to internal schema (see config file for defaults). |
| `field_aliases.idp_count` | no | Candidate columns used to detect the IDP count. |
| `output.measure` | no | Set to `stock` (default) to convert cumulative figures to flows. |

**Example configuration:**
```yaml
enabled: true
api:
  admin_levels: [admin0, admin1, admin2]
  countries: []
  operations: []
output:
  measure: stock
field_aliases:
  idp_count: ["TotalIDPs", "IDPTotal"]
```

**Diagnostics:** each run emits:
- `diagnostics/ingestion/dtm_run.json` capturing the ingestion window, filters, HTTP status counts (`2xx`, `4xx`, `5xx`, `timeout`, `error`), and row totals (`admin0`, `admin1`, `admin2`, `total`).
- `diagnostics/ingestion/dtm_api_request.json` summarising the requested admin levels, countries, operations, and date window.
- `diagnostics/ingestion/dtm_api_response_sample.json` containing the first 100 standardized output rows for quick inspection.
### Output metadata

- `data/staging/dtm_displacement.csv.meta.json` mirrors the CSV output and records:
  - `row_count`: number of written rows (excluding the header).
  - `backfill_start`/`backfill_end`: the effective ingestion window resolved from environment variables.
  - `sources_total`, `sources_valid`, `sources_invalid`: summary counts after configuration and runtime validation.
- `diagnostics/ingestion/dtm_run.json` is rewritten on every execution and has the shape:

```jsonc
{
  "mode": "api",
  "trigger": "api-only",
  "admin_levels": ["admin0", "admin1", "admin2"],
  "countries": null,
  "operations": null,
  "window_start": "2024-01-01",
  "window_end": "2024-02-01",
  "http_counts": {"2xx": 3, "4xx": 0, "5xx": 0, "timeout": 0, "error": 0},
  "row_counts": {"admin0": 1, "admin1": 1, "admin2": 0, "total": 2}
}
```

Runs that write no data rows are classified as **ok-empty** and emit the message `header-only; kept=0`. The connector summary reads the `row_counts.total` field to populate the Markdown table.
