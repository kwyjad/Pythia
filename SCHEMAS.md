<!--- DO NOT EDIT: generated by resolver/tools/generate_schemas_md.py on 2025-10-22Z -->

# Resolver Schemas

## Table of contents

- [staging.common](#stagingcommon)
- [staging.reliefweb_pdf](#stagingreliefwebpdf)
- [staging.unhcr_odp](#stagingunhcrodp)
- [staging.worldpop](#stagingworldpop)
- [db.facts_raw](#dbfactsraw)
- [db.facts_resolved](#dbfactsresolved)
- [db.facts_deltas](#dbfactsdeltas)
- [db.snapshots](#dbsnapshots)
- [db.manifests](#dbmanifests)
- [context.facts_last12](#contextfacts_last12)
- [Ingestion Diagnostics Schema](#ingestion-diagnostics-schema)

## staging.common

Canonical staging columns for event-centric connectors.

| Name | Type | Required | Enum/Format | Description |
| --- | --- | --- | --- | --- |
| event_id | string | yes |  |  |
| country_name | string | yes |  |  |
| iso3 | string | yes |  |  |
| hazard_code | string | yes |  |  |
| hazard_label | string | yes |  |  |
| hazard_class | string | yes |  |  |
| metric | enum | yes | in_need, affected, displaced, cases, fatalities<br>events, participants |  |
| series_semantics | enum | no | stock, new |  |
| value | number | yes |  |  |
| unit | enum | yes | persons, persons_cases, events |  |
| as_of_date | string | yes |  | ISO-8601 date (YYYY-MM-DD) |
| publication_date | string | yes |  | ISO-8601 date (YYYY-MM-DD) |
| publisher | string | yes |  |  |
| source_type | string | yes |  |  |
| source_url | string | yes |  |  |
| doc_title | string | yes |  |  |
| definition_text | string | yes |  |  |
| method | string | yes |  |  |
| confidence | string | yes |  |  |
| revision | integer | yes |  |  |
| ingested_at | date | yes |  |  |
| value_new | number | no |  |  |
| value_stock | number | no |  |  |
| rebase_flag | integer | no |  |  |
| first_observation | integer | no |  |  |
| delta_negative_clamped | integer | no |  |  |

## staging.reliefweb_pdf

ReliefWeb PDF staging output with attachment metadata.

| Name | Type | Required | Enum/Format | Description |
| --- | --- | --- | --- | --- |
| extraction_layer | string | no |  |  |
| matched_phrase | string | no |  |  |
| method_details | string | no |  |  |
| method_value | string | no |  |  |
| month_start | string | no |  |  |
| resource_url | string | no |  |  |
| tier | string | no |  |  |
| value_level | number | no |  |  |

## staging.unhcr_odp

UNHCR Operational Data Portal staging output.

| Name | Type | Required | Enum/Format | Description |
| --- | --- | --- | --- | --- |
| source | string | yes |  |  |
| source_event_id | string | yes |  |  |
| as_of_date | date | yes |  |  |
| country_iso3 | string | yes |  |  |
| country_name | string | yes |  |  |
| hazard_code | string | yes |  |  |
| hazard_label | string | yes |  |  |
| hazard_class | string | yes |  |  |
| metric_name | string | yes |  |  |
| metric_unit | string | yes |  |  |
| series_semantics | enum | no | stock, new |  |
| value | number | yes |  |  |
| evidence_url | string | yes |  |  |
| evidence_label | string | yes |  |  |

## staging.worldpop

WorldPop denominators staging output.

| Name | Type | Required | Enum/Format | Description |
| --- | --- | --- | --- | --- |
| iso3 | string | yes |  |  |
| year | integer | yes |  |  |
| population | number | yes |  |  |
| source | string | yes |  |  |
| product | string | yes |  |  |
| download_date | date | yes |  |  |
| source_url | string | yes |  |  |
| notes | string | no |  |  |

## db.facts_raw

Canonical facts written to DuckDB alongside CSV exports.

| Name | Type | Required | Enum/Format | Description |
| --- | --- | --- | --- | --- |
| event_id | string | yes |  |  |
| country_name | string | yes |  |  |
| iso3 | string | yes |  |  |
| hazard_code | string | yes |  |  |
| hazard_label | string | yes |  |  |
| hazard_class | string | yes |  |  |
| metric | enum | yes | in_need, affected, displaced, cases, fatalities<br>events, participants |  |
| series_semantics | enum | no | stock, new |  |
| value | number | yes |  |  |
| unit | enum | yes | persons, persons_cases, events |  |
| as_of_date | string | yes |  | ISO-8601 date (YYYY-MM-DD) |
| publication_date | string | yes |  | ISO-8601 date (YYYY-MM-DD) |
| publisher | string | yes |  |  |
| source_type | string | yes |  |  |
| source_url | string | no |  |  |
| doc_title | string | yes |  |  |
| definition_text | string | yes |  |  |
| method | string | yes |  |  |
| confidence | string | yes |  |  |
| revision | integer | yes |  |  |
| ingested_at | date | yes |  |  |
| value_new | number | no |  |  |
| value_stock | number | no |  |  |
| rebase_flag | integer | no |  |  |
| first_observation | integer | no |  |  |
| delta_negative_clamped | integer | no |  |  |
| created_at | datetime | no |  |  |

## db.facts_resolved

Resolved precedence outputs stored in DuckDB for querying.

| Name | Type | Required | Enum/Format | Description |
| --- | --- | --- | --- | --- |
| ym | string | yes |  |  |
| iso3 | string | yes |  |  |
| hazard_code | string | yes |  |  |
| hazard_label | string | yes |  |  |
| hazard_class | string | yes |  |  |
| metric | enum | yes | in_need, affected, displaced, cases, fatalities<br>events, participants |  |
| series_semantics | enum | no | stock, new |  |
| value | number | yes |  |  |
| unit | enum | yes | persons, persons_cases, events |  |
| as_of_date | string | yes |  | ISO-8601 date (YYYY-MM-DD) |
| publication_date | string | yes |  | ISO-8601 date (YYYY-MM-DD) |
| publisher | string | yes |  |  |
| source_type | string | no |  |  |
| source_url | string | no |  |  |
| doc_title | string | no |  |  |
| definition_text | string | no |  |  |
| precedence_tier | string | no |  |  |
| event_id | string | no |  |  |
| proxy_for | string | no |  |  |
| confidence | string | no |  |  |
| created_at | datetime | no |  |  |

## db.facts_deltas

Monthly "new" deltas derived from resolved totals.

| Name | Type | Required | Enum/Format | Description |
| --- | --- | --- | --- | --- |
| ym | string | yes |  |  |
| iso3 | string | yes |  |  |
| hazard_code | string | yes |  |  |
| metric | enum | yes | in_need, affected, displaced, cases, fatalities<br>events, participants |  |
| value_new | number | yes |  |  |
| value_stock | number | no |  |  |
| series_semantics | enum | no | new |  |
| rebase_flag | integer | no |  |  |
| first_observation | integer | no |  |  |
| delta_negative_clamped | integer | no |  |  |
| as_of | string | yes |  | ISO-8601 date (YYYY-MM-DD) |
| source_name | string | yes |  |  |
| source_url | string | no |  |  |
| definition_text | string | no |  |  |
| created_at | datetime | no |  |  |

## db.snapshots

Snapshot metadata recorded alongside dual-write operations.

| Name | Type | Required | Enum/Format | Description |
| --- | --- | --- | --- | --- |
| ym | string | yes |  |  |
| created_at | datetime | yes |  |  |
| git_sha | string | no |  |  |
| export_version | string | no |  |  |
| facts_rows | integer | no |  |  |
| deltas_rows | integer | no |  |  |
| meta | string | no |  |  |

## db.manifests

Snapshot manifest entries mirroring CSV exports.

| Name | Type | Required | Enum/Format | Description |
| --- | --- | --- | --- | --- |
| ym | string | yes |  |  |
| name | string | yes |  |  |
| path | string | no |  |  |
| rows | integer | no |  |  |
| checksum | string | no |  |  |
| payload | string | no |  |  |
| created_at | datetime | no |  |  |

## context.facts_last12

LLM context bundle summarising monthly new-series PIN/PA totals.

Column order is canonical: `iso3`, `hazard_code`, `ym`, `metric`, `unit`, `value`, `series`. The builder returns an empty DataFrame with these columns when no months are available so downstream consumers can rely on the schema.

| Name | Type | Required | Enum/Format | Description |
| --- | --- | --- | --- | --- |
| iso3 | string | yes |  |  |
| hazard_code | string | yes |  |  |
| ym | string | yes |  | Year-month bucket (YYYY-MM) |
| metric | enum | yes | in_need, affected |  |
| unit | string | yes |  | Measurement unit (`persons` rows are rounded to whole numbers) |
| value | number | yes |  | Numeric total per month/metric |
| series | enum | yes | new |  |

## Ingestion Diagnostics Schema

Structured JSONL lines emitted by `resolver/ingestion/run_all_stubs.py` and summarised by `scripts/ci/summarize_connectors.py`.

| Field | Type | Required | Description |
| --- | --- | --- | --- |
| connector_id | string | yes | Canonical connector identifier (e.g. `acled_client`). |
| mode | enum | yes | `real` or `stub`. |
| status | enum | yes | `ok`, `skipped`, or `error`. |
| reason | string | no | Normalised skip/failure reason (for example `disabled: config`, `missing secret ACLED_TOKEN`, `upstream-502`). |
| started_at_utc | string | yes | ISO-8601 UTC timestamp of the attempt start. |
| duration_ms | integer | yes | Total runtime in milliseconds. |
| http | object | yes | HTTP telemetry with keys `2xx`, `4xx`, `5xx`, `retries`, `rate_limit_remaining`, and `last_status`. |
| counts | object | yes | Row totals with keys `fetched`, `normalized`, and `written`. |
| coverage | object | yes | Time-window coverage: `ym_min`, `ym_max`, `as_of_min`, `as_of_max` (nullable). |
| samples | object | yes | Top samples (arrays of `[value, count]`) under `top_iso3` and `top_hazard`. |
| extras | object | no | Connector-specific metadata (for example `rows_method`, `rows_before`, `rows_written`). Sensitive values are redacted to `***`. |

Example JSONL entry:

```json
{
  "connector_id": "acled_client",
  "mode": "real",
  "status": "ok",
  "reason": null,
  "started_at_utc": "2024-02-01T02:04:12Z",
  "duration_ms": 182345,
  "http": {"2xx": 42, "4xx": 0, "5xx": 0, "retries": 1, "rate_limit_remaining": 75, "last_status": 200},
  "counts": {"fetched": 520, "normalized": 515, "written": 510},
  "coverage": {"ym_min": "2023-12", "ym_max": "2024-01", "as_of_min": "2024-01-05", "as_of_max": "2024-01-31"},
  "samples": {"top_iso3": [["KEN", 120], ["UGA", 95]], "top_hazard": [["conflict", 140]]},
  "extras": {"rows_method": "manifest", "rows_before": 0, "rows_written": 510}
}
```

## DTM API diagnostics

The DTM connector is API-only and always calls the official DTM API via the `dtmapi` package.

**Secrets:**
- `DTM_API_PRIMARY_KEY` or legacy `DTM_API_KEY` (required).
- `DTM_API_SECONDARY_KEY` (optional) retried on authentication failures.

**Configuration fields:**

| Field | Required | Description |
| --- | --- | --- |
| `api.admin_levels` | no | Levels to fetch (`admin0`, `admin1`, `admin2`). Defaults to `admin1` and `admin0`. |
| `api.countries` | no | ISO3 codes or country names. Empty list ⇒ fetch all available countries. |
| `api.operations` | no | Operation names for admin2 pulls. |
| `field_mapping` | no | Overrides for API column names (rarely needed). |
| `field_aliases.idp_count` | no | Candidate columns containing the IDP total. |
| `output.measure` | no | `stock` (default) converts cumulative totals to flows; `flow` keeps month deltas. |

**Example configuration:**
```yaml
enabled: true
api:
  admin_levels: [admin1, admin0]
  countries: []
  operations: []
output:
  measure: stock
field_aliases:
  idp_count: ["TotalIDPs", "IDPTotal"]
```

**Diagnostics:** each execution writes:
- `diagnostics/ingestion/dtm_run.json` summarising the ingestion window, requested and resolved countries, HTTP counters (`2xx`, `4xx`, `5xx`, `timeout`, `error`, `retries`, `last_status`), paging (`pages`, `page_size`, `total_received`), and row totals (`admin0`, `admin1`, `admin2`, `total`).
- `diagnostics/ingestion/dtm_api_request.json` recording admin levels, countries, operations, and the date window passed to the API (secrets redacted).
- `diagnostics/ingestion/dtm_api_sample.json` (and the legacy `dtm_api_response_sample.json`) containing up to 100 standardized rows. Always present when the run produced zero rows.

**Output metadata:**
- `data/staging/dtm_displacement.csv.meta.json` captures the CSV row count plus the resolved ingestion window.
- `diagnostics/ingestion/dtm_run.json` now has the shape:

```jsonc
{
  "window": {"start": "2024-01-01", "end": "2024-02-01"},
  "countries": {"requested": ["KEN"], "resolved": ["Kenya"]},
  "http": {"2xx": 3, "4xx": 0, "5xx": 0, "timeout": 0, "error": 0, "retries": 0, "last_status": 200},
  "paging": {"pages": 3, "page_size": 500, "total_received": 1200},
  "rows": {"fetched": 1200, "normalized": 1180, "written": 1180, "kept": 1180, "dropped": 20},
  "status": "ok",
  "reason": "wrote 1180 rows",
  "outputs": {"csv": "data/staging/dtm_displacement.csv", "meta": "data/staging/dtm_displacement.csv.meta.json"},
  "extras": {"api_sample_path": "diagnostics/ingestion/dtm_api_sample.json"}
}
```

**Exit codes:**

| Exit code | Status | Description |
| --- | --- | --- |
| `0` | `ok` | Successful run with at least one row written. |
| `0` | `ok-empty` | Successful run with zero rows (header-only output). |
| `3` | `ok-empty` | Zero rows with `--strict-empty`/`DTM_STRICT_EMPTY=1`. |
| `2` | `error` | Configuration or authentication failure (missing key, invalid config). |
| `1` | `error` | Runtime exception (network failure, unexpected API error). |
| `skipped` | `skipped` | `RESOLVER_SKIP_DTM=1` or connector disabled in config. |

Zero-row runs are marked `ok-empty`; `dtm_api_sample.json` captures the API response sample to help diagnose the cause.
