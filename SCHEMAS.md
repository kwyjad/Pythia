<!--- DO NOT EDIT: generated by resolver/tools/generate_schemas_md.py on 2025-10-22Z -->

# Resolver Schemas

## Table of contents

- [staging.common](#stagingcommon)
- [staging.reliefweb_pdf](#stagingreliefwebpdf)
- [staging.unhcr_odp](#stagingunhcrodp)
- [staging.worldpop](#stagingworldpop)
- [db.facts_raw](#dbfactsraw)
- [db.facts_resolved](#dbfactsresolved)
- [db.facts_deltas](#dbfactsdeltas)
- [db.snapshots](#dbsnapshots)
- [db.manifests](#dbmanifests)
- [context.facts_last12](#contextfacts_last12)
- [Ingestion Diagnostics Schema](#ingestion-diagnostics-schema)

## staging.common

Canonical staging columns for event-centric connectors.

| Name | Type | Required | Enum/Format | Description |
| --- | --- | --- | --- | --- |
| event_id | string | yes |  |  |
| country_name | string | yes |  |  |
| iso3 | string | yes |  |  |
| hazard_code | string | yes |  |  |
| hazard_label | string | yes |  |  |
| hazard_class | string | yes |  |  |
| metric | enum | yes | in_need, affected, displaced, cases, fatalities<br>events, participants |  |
| series_semantics | enum | no | stock, new |  |
| value | number | yes |  |  |
| unit | enum | yes | persons, persons_cases, events |  |
| as_of_date | string | yes |  | ISO-8601 date (YYYY-MM-DD) |
| publication_date | string | yes |  | ISO-8601 date (YYYY-MM-DD) |
| publisher | string | yes |  |  |
| source_type | string | yes |  |  |
| source_url | string | yes |  |  |
| doc_title | string | yes |  |  |
| definition_text | string | yes |  |  |
| method | string | yes |  |  |
| confidence | string | yes |  |  |
| revision | integer | yes |  |  |
| ingested_at | date | yes |  |  |
| value_new | number | no |  |  |
| value_stock | number | no |  |  |
| rebase_flag | integer | no |  |  |
| first_observation | integer | no |  |  |
| delta_negative_clamped | integer | no |  |  |

## staging.reliefweb_pdf

ReliefWeb PDF staging output with attachment metadata.

| Name | Type | Required | Enum/Format | Description |
| --- | --- | --- | --- | --- |
| extraction_layer | string | no |  |  |
| matched_phrase | string | no |  |  |
| method_details | string | no |  |  |
| method_value | string | no |  |  |
| month_start | string | no |  |  |
| resource_url | string | no |  |  |
| tier | string | no |  |  |
| value_level | number | no |  |  |

## staging.unhcr_odp

UNHCR Operational Data Portal staging output.

| Name | Type | Required | Enum/Format | Description |
| --- | --- | --- | --- | --- |
| source | string | yes |  |  |
| source_event_id | string | yes |  |  |
| as_of_date | date | yes |  |  |
| country_iso3 | string | yes |  |  |
| country_name | string | yes |  |  |
| hazard_code | string | yes |  |  |
| hazard_label | string | yes |  |  |
| hazard_class | string | yes |  |  |
| metric_name | string | yes |  |  |
| metric_unit | string | yes |  |  |
| series_semantics | enum | no | stock, new |  |
| value | number | yes |  |  |
| evidence_url | string | yes |  |  |
| evidence_label | string | yes |  |  |

## staging.worldpop

WorldPop denominators staging output.

| Name | Type | Required | Enum/Format | Description |
| --- | --- | --- | --- | --- |
| iso3 | string | yes |  |  |
| year | integer | yes |  |  |
| population | number | yes |  |  |
| source | string | yes |  |  |
| product | string | yes |  |  |
| download_date | date | yes |  |  |
| source_url | string | yes |  |  |
| notes | string | no |  |  |

## db.facts_raw

Canonical facts written to DuckDB alongside CSV exports.

| Name | Type | Required | Enum/Format | Description |
| --- | --- | --- | --- | --- |
| event_id | string | yes |  |  |
| country_name | string | yes |  |  |
| iso3 | string | yes |  |  |
| hazard_code | string | yes |  |  |
| hazard_label | string | yes |  |  |
| hazard_class | string | yes |  |  |
| metric | enum | yes | in_need, affected, displaced, cases, fatalities<br>events, participants |  |
| series_semantics | enum | no | stock, new |  |
| value | number | yes |  |  |
| unit | enum | yes | persons, persons_cases, events |  |
| as_of_date | string | yes |  | ISO-8601 date (YYYY-MM-DD) |
| publication_date | string | yes |  | ISO-8601 date (YYYY-MM-DD) |
| publisher | string | yes |  |  |
| source_type | string | yes |  |  |
| source_url | string | no |  |  |
| doc_title | string | yes |  |  |
| definition_text | string | yes |  |  |
| method | string | yes |  |  |
| confidence | string | yes |  |  |
| revision | integer | yes |  |  |
| ingested_at | date | yes |  |  |
| value_new | number | no |  |  |
| value_stock | number | no |  |  |
| rebase_flag | integer | no |  |  |
| first_observation | integer | no |  |  |
| delta_negative_clamped | integer | no |  |  |
| created_at | datetime | no |  |  |

## db.facts_resolved

Resolved precedence outputs stored in DuckDB for querying.

| Name | Type | Required | Enum/Format | Description |
| --- | --- | --- | --- | --- |
| ym | string | yes |  |  |
| iso3 | string | yes |  |  |
| hazard_code | string | yes |  |  |
| hazard_label | string | yes |  |  |
| hazard_class | string | yes |  |  |
| metric | enum | yes | in_need, affected, displaced, cases, fatalities<br>events, participants |  |
| series_semantics | enum | no | stock, new |  |
| value | number | yes |  |  |
| unit | enum | yes | persons, persons_cases, events |  |
| as_of_date | string | yes |  | ISO-8601 date (YYYY-MM-DD) |
| publication_date | string | yes |  | ISO-8601 date (YYYY-MM-DD) |
| publisher | string | yes |  |  |
| source_type | string | no |  |  |
| source_url | string | no |  |  |
| doc_title | string | no |  |  |
| definition_text | string | no |  |  |
| precedence_tier | string | no |  |  |
| event_id | string | no |  |  |
| proxy_for | string | no |  |  |
| confidence | string | no |  |  |
| created_at | datetime | no |  |  |

## db.facts_deltas

Monthly "new" deltas derived from resolved totals.

| Name | Type | Required | Enum/Format | Description |
| --- | --- | --- | --- | --- |
| ym | string | yes |  |  |
| iso3 | string | yes |  |  |
| hazard_code | string | yes |  |  |
| metric | enum | yes | in_need, affected, displaced, cases, fatalities<br>events, participants |  |
| value_new | number | yes |  |  |
| value_stock | number | no |  |  |
| series_semantics | enum | no | new |  |
| rebase_flag | integer | no |  |  |
| first_observation | integer | no |  |  |
| delta_negative_clamped | integer | no |  |  |
| as_of | string | yes |  | ISO-8601 date (YYYY-MM-DD) |
| source_name | string | yes |  |  |
| source_url | string | no |  |  |
| definition_text | string | no |  |  |
| created_at | datetime | no |  |  |

## db.snapshots

Snapshot metadata recorded alongside dual-write operations.

| Name | Type | Required | Enum/Format | Description |
| --- | --- | --- | --- | --- |
| ym | string | yes |  |  |
| created_at | datetime | yes |  |  |
| git_sha | string | no |  |  |
| export_version | string | no |  |  |
| facts_rows | integer | no |  |  |
| deltas_rows | integer | no |  |  |
| meta | string | no |  |  |

## db.manifests

Snapshot manifest entries mirroring CSV exports.

| Name | Type | Required | Enum/Format | Description |
| --- | --- | --- | --- | --- |
| ym | string | yes |  |  |
| name | string | yes |  |  |
| path | string | no |  |  |
| rows | integer | no |  |  |
| checksum | string | no |  |  |
| payload | string | no |  |  |
| created_at | datetime | no |  |  |

## context.facts_last12

LLM context bundle summarising monthly new-series PIN/PA totals.

Column order is canonical: `iso3`, `hazard_code`, `ym`, `metric`, `unit`, `value`, `series`. The builder returns an empty DataFrame with these columns when no months are available so downstream consumers can rely on the schema.

| Name | Type | Required | Enum/Format | Description |
| --- | --- | --- | --- | --- |
| iso3 | string | yes |  |  |
| hazard_code | string | yes |  |  |
| ym | string | yes |  | Year-month bucket (YYYY-MM) |
| metric | enum | yes | in_need, affected |  |
| unit | string | yes |  | Measurement unit (`persons` rows are rounded to whole numbers) |
| value | number | yes |  | Numeric total per month/metric |
| series | enum | yes | new |  |

## Ingestion Diagnostics Schema

Structured JSONL lines emitted by `resolver/ingestion/run_all_stubs.py` and summarised by `scripts/ci/summarize_connectors.py`.

| Field | Type | Required | Description |
| --- | --- | --- | --- |
| connector_id | string | yes | Canonical connector identifier (e.g. `acled_client`). |
| mode | enum | yes | `real` or `stub`. |
| status | enum | yes | `ok`, `skipped`, or `error`. |
| reason | string | no | Normalised skip/failure reason (for example `disabled: config`, `missing secret ACLED_TOKEN`, `upstream-502`). |
| started_at_utc | string | yes | ISO-8601 UTC timestamp of the attempt start. |
| duration_ms | integer | yes | Total runtime in milliseconds. |
| http | object | yes | HTTP telemetry with keys `2xx`, `4xx`, `5xx`, `retries`, `rate_limit_remaining`, and `last_status`. |
| counts | object | yes | Row totals with keys `fetched`, `normalized`, and `written`. |
| coverage | object | yes | Time-window coverage: `ym_min`, `ym_max`, `as_of_min`, `as_of_max` (nullable). |
| samples | object | yes | Top samples (arrays of `[value, count]`) under `top_iso3` and `top_hazard`. |
| extras | object | no | Connector-specific metadata (for example `rows_method`, `rows_before`, `rows_written`). Sensitive values are redacted to `***`. |

Example JSONL entry:

```json
{
  "connector_id": "acled_client",
  "mode": "real",
  "status": "ok",
  "reason": null,
  "started_at_utc": "2024-02-01T02:04:12Z",
  "duration_ms": 182345,
  "http": {"2xx": 42, "4xx": 0, "5xx": 0, "retries": 1, "rate_limit_remaining": 75, "last_status": 200},
  "counts": {"fetched": 520, "normalized": 515, "written": 510},
  "coverage": {"ym_min": "2023-12", "ym_max": "2024-01", "as_of_min": "2024-01-05", "as_of_max": "2024-01-31"},
  "samples": {"top_iso3": [["KEN", 120], ["UGA", 95]], "top_hazard": [["conflict", 140]]},
  "extras": {"rows_method": "manifest", "rows_before": 0, "rows_written": 510}
}
```

## DTM source configuration

Each `resolver/ingestion/config/dtm.yml` entry must declare a file-like source. The
preflight validator enforces the required fields before ingestion starts and
records any missing values in `diagnostics/ingestion/dtm_config_issues.json`.

| Field | Required | Description |
| --- | --- | --- |
| `id_or_path` | yes | Absolute path or cloud identifier for the CSV payload. The connector skips entries that omit this value and records the failure in diagnostics. |
| `name` | no | Friendly name used in logs and diagnostics. Defaults to the `id_or_path` when omitted. |
| `type` | no | Source type. Only `file` is currently supported. |
| `measure` | no | Set to `stock` (default) to derive flows or `flow` when the CSV already reports per-period movements. |
| `country_column`, `admin1_column`, `date_column`, `value_column`, `cause_column` | no | Optional overrides for column detection. When unspecified the connector infers columns using common aliases. The runtime validator confirms that the resolved `date_column` exists; sources with missing columns are listed under `diagnostics/ingestion/dtm_run.json` → `sources.invalid`. |

When `LOG_LEVEL=DEBUG`, the resolved source list is mirrored to
`diagnostics/ingestion/dtm_sources_resolved.json` for triage.

### Output metadata

- `data/staging/dtm_displacement.csv.meta.json` mirrors the CSV output and records:
  - `row_count`: number of written rows (excluding the header).
  - `backfill_start`/`backfill_end`: the effective ingestion window resolved from environment variables.
  - `sources_total`, `sources_valid`, `sources_invalid`: summary counts after configuration and runtime validation.
  - `request_url`/`request_urls`: the resolved API endpoint(s) used for the latest run (secrets redacted).
  - `status_histogram`: HTTP status counts observed while fetching pages.
  - `pages`: total requests issued for the run.
  - `auth_used`: which API key (`primary`/`secondary`/`none`) completed the fetch.
- `diagnostics/ingestion/dtm_run.json` is rewritten on every execution and has the shape:

```jsonc
{
  "window": {"start": "2023-01-01", "end": "2023-12-31", "disabled": false},
  "outputs": {"csv": "…", "meta": "…"},
  "sources": {
    "valid": [
      {"name": "…", "rows_before": 10, "rows_after": 8, "dropped": 2,
       "parse_errors": 1, "min": "2023-01-01", "max": "2023-02-01"}
    ],
    "invalid": [
      {"name": "missing-id", "reason": "missing id_or_path"},
      {"name": "missing-date", "reason": "missing date_column"}
    ]
  },
  "totals": {
    "rows_before": 12,
    "rows_after": 8,
    "rows_written": 8,
    "kept": 8,
    "dropped": 4,
    "parse_errors": 1,
    "invalid_sources": 2
  },
  "http": {
    "status_histogram": {"200": 3, "401": 1},
    "pages": 4,
    "auth_used": "secondary",
    "request_urls": ["https://…page=1", "https://…page=1", "https://…page=2"]
  }
}
```

Runs that write no data rows are classified as **ok-empty** and emit reasons such as `header-only; 2 sources invalid; kept=0`. The connector summary reads the `totals.kept`, `totals.dropped`, and `totals.parse_errors` fields to populate the dedicated columns in the Markdown table.
