<!--- DO NOT EDIT: generated by resolver/tools/generate_schemas_md.py on 2025-10-06Z -->

# Resolver Schemas

## Table of contents

- [db.facts_deltas](#dbfactsdeltas)
- [db.facts_raw](#dbfactsraw)
- [db.facts_resolved](#dbfactsresolved)
- [db.manifests](#dbmanifests)
- [db.snapshots](#dbsnapshots)
- [staging.common](#stagingcommon)
- [staging.unhcr_odp](#stagingunhcrodp)
- [staging.worldpop](#stagingworldpop)

> **DuckDB dual-write:** set `RESOLVER_DB_URL` (for example,
> `duckdb:///resolver/db/resolver.duckdb`) to mirror resolver exports and
> snapshots into the tables documented below. When unset, the tooling remains
> file-backed only.
>
> **Writer behaviour:** the DuckDB loader aliases the staging column
> `series_semantics_out` to the canonical `series_semantics` field, coerces
> missing values to the empty string, and ignores unexpected debug columns
> during upserts so schema drift does not interrupt exports. The canonical
> semantics for both CSV and DuckDB outputs come from
> [`resolver.common.series_semantics.compute_series_semantics`](resolver/common/series_semantics.py),
> which reads [`resolver/config/series_semantics.yml`](resolver/config/series_semantics.yml)
> to normalise configured metrics (currently `in_need` â†’ `stock`) while leaving
> all other non-empty values untouched. Before deduplication the writer
> canonicalises `series_semantics` into `{ "", "new", "stock" }` so mixed-case
> or "none" values collapse to the same primary key. Dual writes delete and
> reinsert rows by the natural keys listed below so repeating an export or
> snapshot for the same month yields identical state:
>
> - `facts_resolved`: (`ym`, `iso3`, `hazard_code`, `metric`, `series_semantics`)
> - `facts_deltas`: (`ym`, `iso3`, `hazard_code`, `metric`)
>
> Snapshot writes delete the target month from `facts_resolved`, `facts_deltas`,
> and manifests before upserting the fresh data and recording a single row in
> `snapshots`. Inserts always specify the explicit column list (no `SELECT *`)
> to ensure column order drift never misaligns values.
>
> Staging-only columns such as `country_name`, `method`, `revision`, and
> `ingested_at` are intentionally omitted from the resolved tables and are only
> reported at DEBUG level when they are dropped during upserts.

## db.facts_deltas

Monthly "new" deltas derived from resolved totals.

| Name | Type | Required | Enum/Format | Description |
| --- | --- | --- | --- | --- |
| as_of | date | yes |  |  |
| hazard_code | string | yes |  |  |
| iso3 | string | yes |  |  |
| metric | enum | yes | in_need, affected, displaced, cases, fatalities<br>events, participants |  |
| source_name | string | yes |  |  |
| value_new | number | yes |  |  |
| ym | string | yes |  |  |
| created_at | datetime | no |  |  |
| definition_text | string | no |  |  |
| delta_negative_clamped | integer | no |  |  |
| first_observation | integer | no |  |  |
| rebase_flag | integer | no |  |  |
| series_semantics | enum | no | new |  |
| source_url | string | no |  |  |
| value_stock | number | no |  |  |

## db.facts_raw

Canonical facts written to DuckDB alongside CSV exports.

| Name | Type | Required | Enum/Format | Description |
| --- | --- | --- | --- | --- |
| as_of_date | date | yes |  |  |
| confidence | string | yes |  |  |
| country_name | string | yes |  |  |
| definition_text | string | yes |  |  |
| doc_title | string | yes |  |  |
| event_id | string | yes |  |  |
| hazard_class | string | yes |  |  |
| hazard_code | string | yes |  |  |
| hazard_label | string | yes |  |  |
| ingested_at | date | yes |  |  |
| iso3 | string | yes |  |  |
| method | string | yes |  |  |
| metric | enum | yes | in_need, affected, displaced, cases, fatalities<br>events, participants |  |
| publication_date | date | yes |  |  |
| publisher | string | yes |  |  |
| revision | integer | yes |  |  |
| source_type | string | yes |  |  |
| unit | enum | yes | persons, persons_cases, events |  |
| value | number | yes |  |  |
| created_at | datetime | no |  |  |
| delta_negative_clamped | integer | no |  |  |
| first_observation | integer | no |  |  |
| rebase_flag | integer | no |  |  |
| series_semantics | enum | no | new (default), stock | Deltas remain `new` unless staged aliases override them. |
| source_url | string | no |  |  |
| value_new | number | no |  |  |
| value_stock | number | no |  |  |

## db.facts_resolved

Resolved precedence outputs stored in DuckDB for querying.

| Name | Type | Required | Enum/Format | Description |
| --- | --- | --- | --- | --- |
| as_of_date | date | yes |  |  |
| hazard_class | string | yes |  |  |
| hazard_code | string | yes |  |  |
| hazard_label | string | yes |  |  |
| iso3 | string | yes |  |  |
| metric | enum | yes | in_need, affected, displaced, cases, fatalities<br>events, participants |  |
| publication_date | date | yes |  |  |
| publisher | string | yes |  |  |
| unit | enum | yes | persons, persons_cases, events |  |
| value | number | yes |  |  |
| ym | string | yes |  |  |
| confidence | string | no |  |  |
| created_at | datetime | no |  |  |
| definition_text | string | no |  |  |
| doc_title | string | no |  |  |
| event_id | string | no |  |  |
| precedence_tier | string | no |  |  |
| proxy_for | string | no |  |  |
| series_semantics | enum | no | "" (default), stock | Derived via the series semantics helper; blank when no configured mapping applies. |
| source_type | string | no |  |  |
| source_url | string | no |  |  |

## db.manifests

Snapshot manifest entries mirroring CSV exports.

| Name | Type | Required | Enum/Format | Description |
| --- | --- | --- | --- | --- |
| name | string | yes |  |  |
| ym | string | yes |  |  |
| checksum | string | no |  |  |
| created_at | datetime | no |  |  |
| path | string | no |  |  |
| payload | string | no |  |  |
| rows | integer | no |  |  |

## db.snapshots

Snapshot metadata recorded alongside dual-write operations.

| Name | Type | Required | Enum/Format | Description |
| --- | --- | --- | --- | --- |
| created_at | datetime | yes |  |  |
| ym | string | yes |  |  |
| deltas_rows | integer | no |  |  |
| export_version | string | no |  |  |
| facts_rows | integer | no |  |  |
| git_sha | string | no |  |  |
| meta | string | no |  |  |

## staging.common

Canonical staging columns for event-centric connectors.

| Name | Type | Required | Enum/Format | Description |
| --- | --- | --- | --- | --- |
| as_of_date | date | yes |  |  |
| confidence | string | yes |  |  |
| country_name | string | yes |  |  |
| definition_text | string | yes |  |  |
| doc_title | string | yes |  |  |
| event_id | string | yes |  |  |
| hazard_class | string | yes |  |  |
| hazard_code | string | yes |  |  |
| hazard_label | string | yes |  |  |
| ingested_at | date | yes |  |  |
| iso3 | string | yes |  |  |
| method | string | yes |  |  |
| metric | enum | yes | in_need, affected, displaced, cases, fatalities<br>events, participants |  |
| publication_date | date | yes |  |  |
| publisher | string | yes |  |  |
| revision | integer | yes |  |  |
| source_type | string | yes |  |  |
| source_url | string | yes |  |  |
| unit | enum | yes | persons, persons_cases, events |  |
| value | number | yes |  |  |
| delta_negative_clamped | integer | no |  |  |
| first_observation | integer | no |  |  |
| rebase_flag | integer | no |  |  |
| series_semantics | enum | no | stock, new |  |
| value_new | number | no |  |  |
| value_stock | number | no |  |  |

## staging.unhcr_odp

UNHCR Operational Data Portal staging output.

| Name | Type | Required | Enum/Format | Description |
| --- | --- | --- | --- | --- |
| as_of_date | date | yes |  |  |
| country_iso3 | string | yes |  |  |
| country_name | string | yes |  |  |
| evidence_label | string | yes |  |  |
| evidence_url | string | yes |  |  |
| hazard_class | string | yes |  |  |
| hazard_code | string | yes |  |  |
| hazard_label | string | yes |  |  |
| metric_name | string | yes |  |  |
| metric_unit | string | yes |  |  |
| source | string | yes |  |  |
| source_event_id | string | yes |  |  |
| value | number | yes |  |  |
| series_semantics | enum | no | stock, new |  |

## staging.worldpop

WorldPop denominators staging output.

| Name | Type | Required | Enum/Format | Description |
| --- | --- | --- | --- | --- |
| download_date | date | yes |  |  |
| iso3 | string | yes |  |  |
| population | number | yes |  |  |
| product | string | yes |  |  |
| source | string | yes |  |  |
| source_url | string | yes |  |  |
| year | integer | yes |  |  |
| notes | string | no |  |  |
