name: Build dashboard data

on:
  workflow_dispatch:
  push:
    branches: [ main ]

jobs:
  build-parquet:
    runs-on: ubuntu-24.04
    steps:
      - uses: actions/checkout@v4

      - uses: actions/setup-python@v5
        with:
          python-version: '3.11'

      - name: Install pandas/pyarrow
        run: |
          python -m pip install --upgrade pip
          pip install pandas pyarrow

      - name: Build forecasts.parquet
        shell: bash
        run: |
          python - << 'PY'
          import pandas as pd, os
          src_csv_candidates = [
              "forecast_logs/forecasts.csv",
              "forecasts.csv",
              "logs/forecasts.csv",
          ]
          path = next((c for c in src_csv_candidates if os.path.exists(c)), None)
          if not path:
              raise SystemExit("Could not find forecasts.csv; adjust candidates.")
          df = pd.read_csv(path)
          out_dir = "Dashboard/data"  # Capital D path
          os.makedirs(out_dir, exist_ok=True)
          df.to_parquet(f"{out_dir}/forecasts.parquet", index=False)
          print("Wrote", f"{out_dir}/forecasts.parquet", "rows:", len(df))
          PY

      - name: Commit updated parquet
        run: |
          git config user.name "github-actions"
          git config user.email "actions@users.noreply.github.com"
          git add -f Dashboard/data/forecasts.parquet
          git commit -m "chore(dashboard): refresh parquet snapshot" || echo "No changes"
          git push
