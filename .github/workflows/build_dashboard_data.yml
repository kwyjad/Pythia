name: Build dashboard data

on:
  workflow_dispatch:
  push:
    branches: [ main ]
    paths:
      - "forecasts.csv"   # ← only rebuild when the CSV changes

jobs:
  build-parquet:
    runs-on: ubuntu-24.04

    steps:
      - uses: actions/checkout@v4

      - uses: actions/setup-python@v5
        with:
          python-version: '3.11'

      - name: Install parquet deps
        run: |
          python -m pip install --upgrade pip
          pip install pandas pyarrow

      - name: Build Dashboard/data/forecasts.parquet
        run: |
          python - <<'PY'
          import os, pandas as pd, pathlib
          # Prefer the root CSV; fall back to forecast_logs if needed
          candidates = ["forecasts.csv", "forecast_logs/forecasts.csv"]
          path = next((p for p in candidates if os.path.exists(p)), None)
          if not path:
              raise SystemExit("Could not find forecasts.csv; adjust candidates.")

          out_dir = pathlib.Path("Dashboard/data")  # Capital D path
          out_dir.mkdir(parents=True, exist_ok=True)

          df = pd.read_csv(path, low_memory=False)
          out_path = out_dir / "forecasts.parquet"
          df.to_parquet(out_path, index=False)
          print("✅ wrote", out_path, "rows:", len(df))
          PY

      - name: Commit updated parquet
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "41898282+github-actions[bot]@users.noreply.github.com"
          git add -f Dashboard/data/forecasts.parquet
          git commit -m "chore(dashboard): refresh parquet snapshot" || echo "No changes"
          git push
