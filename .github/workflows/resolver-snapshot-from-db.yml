---
name: Resolver — Snapshot from DB

on:
  workflow_dispatch:
    inputs:
      months_back:
        description: "Number of months to snapshot (default 36)"
        required: false
        default: "36"
  workflow_run:
    workflows: ["Resolver — Initial Backfill"]
    types:
      - completed

jobs:
  snapshot-from-db:
    if: ${{ github.event_name == 'workflow_dispatch' || github.event.workflow_run.conclusion == 'success' }}
    runs-on: ubuntu-latest
    env:
      DB_URL: "duckdb:////home/runner/work/${{ github.repository }}/data/resolver_backfill.duckdb"

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"

      - name: Install dependencies
        run: |
          set -euo pipefail
          python -m pip install --upgrade pip wheel setuptools
          pip install -c constraints-ci.txt -e '.[db]'

      - name: Download resolver_backfill.duckdb artifact
        uses: actions/download-artifact@v4
        with:
          name: resolver-backfill-db
          path: data

      - name: Determine months_back
        id: months
        run: |
          if [ "${{ github.event_name }}" = "workflow_dispatch" ] && [ -n "${{ github.event.inputs.months_back }}" ]; then
            echo "value=${{ github.event.inputs.months_back }}" >> "$GITHUB_OUTPUT"
          else
            echo "value=36" >> "$GITHUB_OUTPUT"
          fi

      - name: Run snapshot-from-DB CLI
        run: |
          set -euo pipefail
          echo "Using DB_URL=${DB_URL}"
          echo "Snapshotting last ${{ steps.months.outputs.value }} months"
          python -m resolver.cli.snapshot_from_db \
            --db-url "${DB_URL}" \
            --months-back "${{ steps.months.outputs.value }}" \
            --out-dir "snapshots"

      - name: Upload snapshots as artifact
        if: ${{ success() }}
        uses: actions/upload-artifact@v4
        with:
          name: resolver-snapshots
          path: snapshots
