---
name: Resolver — Snapshot from DB

on:
  workflow_run:
    workflows: ["Resolver — Initial Backfill"]
    types:
      - completed

jobs:
  snapshot-from-db:
    if: ${{ github.event.workflow_run.conclusion == 'success' }}
    runs-on: ubuntu-latest
    env:
      DB_URL: "duckdb:///${{ github.workspace }}/data/resolver_backfill.duckdb"
      SNAPSHOT_MONTHS_BACK: "36"

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"

      - name: Install dependencies
        run: |
          set -euo pipefail
          python -m pip install --upgrade pip wheel setuptools
          pip install -c constraints-ci.txt -e '.[db]'

      - name: Download resolver_backfill.duckdb artifact from triggering run
        uses: actions/download-artifact@v4
        with:
          name: resolver-backfill-db
          path: data
          run-id: ${{ github.event.workflow_run.id }}

      - name: Verify downloaded DB file
        run: |
          set -euo pipefail
          echo "Listing data/ directory:"
          ls -lh data || true
          if [ ! -f "data/resolver_backfill.duckdb" ]; then
            echo "ERROR: data/resolver_backfill.duckdb not found after download."
            exit 1
          fi
          echo "Found data/resolver_backfill.duckdb"

      - name: Run snapshot-from-DB CLI
        env:
          DB_URL: "${{ env.DB_URL }}"
          SNAPSHOT_MONTHS_BACK: "${{ env.SNAPSHOT_MONTHS_BACK }}"
        run: |
          set -euo pipefail
          echo "Using DB_URL=${DB_URL}"
          echo "Snapshotting last ${SNAPSHOT_MONTHS_BACK} months"
          python -m resolver.cli.snapshot_from_db \
            --db-url "${DB_URL}" \
            --months-back "${SNAPSHOT_MONTHS_BACK}" \
            --out-dir "snapshots"

      - name: Print snapshot DB summary
        run: |
          set -euo pipefail
          python - << 'PY'
          import duckdb
          from pathlib import Path

          db_path = Path("data/resolver_backfill.duckdb")
          print(f"Snapshot DB summary for {db_path}:")
          con = duckdb.connect(str(db_path))

          def count(table: str) -> None:
              try:
                  n = con.execute(f"SELECT COUNT(*) FROM {table}").fetchone()[0]
                  print(f"  {table}: {n} rows")
              except Exception as exc:
                  print(f"  {table}: ERROR - {exc}")

          for tbl in [
              "facts_resolved",
              "facts_deltas",
              "acled_monthly_fatalities",
              "facts_snapshot",
              "snapshots",
          ]:
              count(tbl)

          try:
              ym_count = con.execute("SELECT COUNT(DISTINCT ym) FROM facts_snapshot").fetchone()[0]
              print(f"  facts_snapshot distinct ym: {ym_count}")
          except Exception as exc:
              print(f"  facts_snapshot distinct ym: ERROR - {exc}")
          PY

      - name: Upload snapshots as artifact
        if: ${{ success() }}
        uses: actions/upload-artifact@v4
        with:
          name: resolver-snapshots
          path: snapshots
