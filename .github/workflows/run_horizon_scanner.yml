---
# This workflow runs the Pythia Horizon Scanner and generates a risk report.

name: Generate Risk Report

concurrency:
  group: pythia-resolver-db
  cancel-in-progress: false

# --- Triggers ---
on:
  # Manual run from the Actions tab
  workflow_dispatch:

# --- Job Definition ---
jobs:
  build-report:
    runs-on: ubuntu-latest
    env:
      RESOLVER_DB_URL: duckdb:///${{ github.workspace }}/data/resolver.duckdb

    steps:
      # Step 1: Check out the repository's code
      - name: Check out code
        uses: actions/checkout@v4

      - name: Install gh CLI
        run: |
          sudo apt-get update
          sudo apt-get install -y gh

      - name: Authenticate gh
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: gh auth status

      - name: Find latest successful Resolver — Initial Backfill run
        id: find_backfill_run
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          RUN_ID=$(gh run list \
            --workflow "Resolver — Initial Backfill" \
            --branch main \
            --status success \
            --json databaseId \
            --limit 1 \
            --jq '.[0].databaseId' || true)

          if [ -z "$RUN_ID" ]; then
            echo "No successful backfill run found; HS will run with a fresh DB."
          else
            echo "Latest backfill run ID: $RUN_ID"
            echo "BACKFILL_RUN_ID=$RUN_ID" >> "$GITHUB_ENV"
          fi

      - name: Download canonical resolver DB (from latest backfill)
        if: env.BACKFILL_RUN_ID != ''
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          mkdir -p data

          echo "Downloading pythia-resolver-db from run $BACKFILL_RUN_ID ..."
          gh run download "$BACKFILL_RUN_ID" -n pythia-resolver-db --dir data

          echo "Downloaded artifacts:"
          ls -R data

          # Canonical layout: data/pythia-resolver-db/resolver.duckdb
          if [ -f data/pythia-resolver-db/resolver.duckdb ]; then
            SRC="data/pythia-resolver-db/resolver.duckdb"
          else
            SRC=$(find data -maxdepth 4 -type f -name "resolver.duckdb" | head -n 1 || true)
          fi

          if [ -n "$SRC" ]; then
            echo "Found resolver DB at $SRC"
            # Only copy if SRC != canonical path
            if [ "$SRC" != "data/resolver.duckdb" ]; then
              cp "$SRC" data/resolver.duckdb
            else
              echo "DB already at canonical path data/resolver.duckdb; no copy needed."
            fi
          fi

          if [ ! -f data/resolver.duckdb ]; then
            echo "WARNING: resolver.duckdb not found in pythia-resolver-db; HS will run on a fresh DB."
          else
            echo "Using canonical DB at data/resolver.duckdb"
          fi

      # Step 2: Set up Python
      - name: Set up Python 3.10
        uses: actions/setup-python@v5
        with:
          python-version: '3.10'

      # Step 3: Diagnostics – workspace layout and key files
      - name: Diagnostics — workspace layout and key files
        run: |
          echo "=== Diagnostics: workspace layout ==="
          echo "PWD: $(pwd)"
          echo ""
          echo "Top-level listing:"
          ls -la
          echo ""
          echo "horizon_scanner directory listing:"
          if [ -d horizon_scanner ]; then
            ls -la horizon_scanner
          else
            echo "✘ MISSING: horizon_scanner directory"
          fi
          echo ""
          echo "Checking for Horizon Scanner files:"
          for f in \
            "horizon_scanner/horizon_scanner.py" \
            "horizon_scanner/db_writer.py" \
            "horizon_scanner/hs_country_list.txt" \
            "horizon_scanner/hs_prompt.py" \
            "python_library_requirements.txt"
          do
            if [ -f "$f" ]; then
              echo "✔ Found $f"
            else
              echo "✘ MISSING: $f"
            fi
          done
          echo ""
          if [ -f python_library_requirements.txt ]; then
            echo "=== python_library_requirements.txt (root) ==="
            cat python_library_requirements.txt
          else
            echo "WARNING: python_library_requirements.txt is missing in $(pwd); dependency install will fail."
          fi

      # Step 4: Install the necessary Python libraries
      - name: Install dependencies
        run: |
          set -e
          echo "Upgrading pip..."
          python -m pip install --upgrade pip
          echo ""
          echo "Installing dependencies from python_library_requirements.txt..."
          if [ ! -f python_library_requirements.txt ]; then
            echo "ERROR: python_library_requirements.txt not found in $(pwd)."
            exit 1
          fi
          pip install -r python_library_requirements.txt

      # Step 5: Diagnostics – confirm GEMINI_API_KEY is present
      - name: Diagnostics — GEMINI_API_KEY presence
        env:
          GEMINI_API_KEY: ${{ secrets.GEMINI_API_KEY }}
        run: |
          if [ -z "${GEMINI_API_KEY:-}" ]; then
            echo "ERROR: GEMINI_API_KEY is NOT set."
            echo "Set it under: Settings > Secrets and variables > Actions."
            exit 1
          else
            echo "GEMINI_API_KEY is set (value hidden)."
          fi

      # Step 6: Run the main Python script (as a module)
      - name: Run Horizon Scanner
        env:
          GEMINI_API_KEY: ${{ secrets.GEMINI_API_KEY }}
        run: |
          set -e
          echo "=== Running horizon_scanner.horizon_scanner as a module ==="
          python -m horizon_scanner.horizon_scanner
          echo "=== horizon_scanner.horizon_scanner completed ==="

      # Step 7: Run Forecaster on newly written HS questions (Pythia mode)
      - name: Run Forecaster (Pythia mode on HS questions)
        env:
          OPENAI_API_KEY: ${{ secrets.OPENAI_API_KEY }}
          ANTHROPIC_API_KEY: ${{ secrets.ANTHROPIC_API_KEY }}
          GEMINI_API_KEY: ${{ secrets.GEMINI_API_KEY }}
          XAI_API_KEY: ${{ secrets.XAI_API_KEY }}
          MODEL_COSTS_JSON: ${{ secrets.MODEL_COSTS_JSON }}
        run: |
          set -e
          echo "=== Running Forecaster in Pythia mode on active HS questions ==="
          python -m forecaster.cli --mode pythia --limit 200 --purpose hs_pipeline
          echo "=== Forecaster (Pythia mode) completed ==="

      # Step 8: Diagnostics – DuckDB + report validation
      - name: Diagnostics — DuckDB and Risk_Report.md
        run: |
          set -e
          echo "=== Post-run diagnostics ==="
          echo "Top-level listing after run:"
          ls -la
          echo ""

          DB_PATH="data/resolver.duckdb"
          if [ -f "$DB_PATH" ]; then
            echo "DuckDB database found at $DB_PATH"
          else
            echo "WARNING: DuckDB database $DB_PATH not found."
          fi

          python scripts/post_run_diagnostics.py --db duckdb:///data/resolver.duckdb

          python - << 'PY'
          import os

          report_path = "Risk_Report.md"
          if os.path.exists(report_path):
              print(f"'{report_path}' exists. Showing first 40 lines:")
              try:
                  with open(report_path, "r", encoding="utf-8") as f:
                      for i, line in enumerate(f):
                          if i >= 40:
                              break
                          print(line.rstrip("\n"))
              except Exception as e:
                  print(f"Failed to read '{report_path}': {e}")
          else:
              print(f"WARNING: '{report_path}' not found.")
          PY

      # Step 9: Upload the final report as an artifact
      - name: Upload Report Artifact
        uses: actions/upload-artifact@v4
        with:
          name: Risk-Analysis-Report
          path: Risk_Report.md

      - name: Dump first forecast prompt
        run: python -m scripts.dump_first_forecast_prompt

      - name: Upload first forecast prompt artifact
        uses: actions/upload-artifact@v4
        with:
          name: first-forecast-prompt
          path: debug_first_forecast_prompt.md

      - name: Dump forecast run debug
        run: python -m scripts.dump_forecast_run_debug

      - name: Upload forecast run debug artifact
        uses: actions/upload-artifact@v4
        with:
          name: forecast-run-debug
          path: forecast_run_debug.md

      - name: Upload canonical resolver DB
        if: success()
        uses: actions/upload-artifact@v4
        with:
          name: pythia-resolver-db
          path: data/resolver.duckdb
