---
# This workflow runs the Pythia Horizon Scanner and generates a risk report.

name: Generate Risk Report

# --- Triggers ---
on:
  # Manual run from the Actions tab
  workflow_dispatch:

# --- Job Definition ---
jobs:
  build-report:
    runs-on: ubuntu-latest

    steps:
      # Step 1: Check out the repository's code
      - name: Check out code
        uses: actions/checkout@v4

      # Step 2: Set up Python
      - name: Set up Python 3.10
        uses: actions/setup-python@v5
        with:
          python-version: '3.10'

      # Step 3: Diagnostics – workspace layout and key files
      - name: Diagnostics — workspace layout and key files
        run: |
          echo "=== Diagnostics: workspace layout ==="
          echo "PWD: $(pwd)"
          echo ""
          echo "Top-level listing:"
          ls -la
          echo ""
          echo ".github/workflows contents:"
          ls -la .github/workflows || echo "(no .github/workflows directory)"
          echo ""
          echo "Checking for Horizon Scanner files:"
          for f in horizon_scanner.py db_writer.py hs_country_list.txt hs_prompt.py python_library_requirements.txt; do
            if [ -f "$f" ]; then
              echo "✔ Found $f"
            else
              echo "✘ MISSING: $f"
            fi
          done
          echo ""
          if [ -f python_library_requirements.txt ]; then
            echo "=== python_library_requirements.txt ==="
            cat python_library_requirements.txt
          else
            echo "WARNING: python_library_requirements.txt is missing; dependency install will fail."
          fi

      # Step 4: Install the necessary Python libraries
      - name: Install dependencies
        run: |
          set -e
          echo "Upgrading pip..."
          python -m pip install --upgrade pip
          echo ""
          echo "Installing dependencies from python_library_requirements.txt..."
          if [ ! -f python_library_requirements.txt ]; then
            echo "ERROR: python_library_requirements.txt not found in $(pwd)."
            exit 1
          fi
          pip install -r python_library_requirements.txt

      # Step 5: Diagnostics – confirm GEMINI_API_KEY is present
      - name: Diagnostics — GEMINI_API_KEY presence
        env:
          GEMINI_API_KEY: ${{ secrets.GEMINI_API_KEY }}
        run: |
          if [ -z "${GEMINI_API_KEY:-}" ]; then
            echo "ERROR: GEMINI_API_KEY is NOT set."
            echo "Set it under: Settings > Secrets and variables > Actions."
            exit 1
          else
            echo "GEMINI_API_KEY is set (value hidden)."
          fi

      # Step 6: Run the main Python script
      - name: Run Horizon Scanner
        env:
          GEMINI_API_KEY: ${{ secrets.GEMINI_API_KEY }}
        run: |
          set -e
          echo "=== Running horizon_scanner.py ==="
          python horizon_scanner.py
          echo "=== horizon_scanner.py completed ==="

      # Step 7: Diagnostics – DuckDB + report validation
      - name: Diagnostics — DuckDB and Risk_Report.md
        run: |
          set -e
          echo "=== Post-run diagnostics ==="
          echo "Top-level listing after run:"
          ls -la
          echo ""

          DB_PATH="data/resolver.duckdb"
          if [ -f "$DB_PATH" ]; then
            echo "DuckDB database found at $DB_PATH"
          else
            echo "WARNING: DuckDB database $DB_PATH not found."
          fi

          python - << 'PY'
            import os

            print("Python post-run diagnostic script starting...")

            db_path = os.path.join("data", "resolver.duckdb")
            if not os.path.exists(db_path):
                print(f"WARNING: DuckDB database '{db_path}' does not exist.")
            else:
                try:
                    import duckdb
                except Exception as e:
                    print(f"ERROR: duckdb module not available in diagnostic step: {e}")
                else:
                    con = duckdb.connect(db_path)
                    for table in ("hs_runs", "hs_scenarios", "questions"):
                        try:
                            cnt = con.execute(f"SELECT COUNT(*) FROM {table}").fetchone()[0]
                            print(f"Table {table}: {cnt} rows")
                        except Exception as e:
                            print(f"Could not query table {table}: {e}")
                    con.close()

            report_path = "Risk_Report.md"
            if os.path.exists(report_path):
                print(f"'{report_path}' exists. Showing first 40 lines:")
                try:
                    with open(report_path, "r", encoding="utf-8") as f:
                        for i, line in enumerate(f):
                            if i >= 40:
                                break
                            print(line.rstrip("\n"))
                except Exception as e:
                    print(f"Failed to read '{report_path}': {e}")
            else:
                print(f"WARNING: '{report_path}' not found.")
          PY

      # Step 8: Upload the final report as an artifact
      - name: Upload Report Artifact
        uses: actions/upload-artifact@v4
        with:
          name: Risk-Analysis-Report
          path: Risk_Report.md
