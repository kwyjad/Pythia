---
name: Forecaster CI â€” SPD

concurrency:
  group: pythia-resolver-db
  cancel-in-progress: false

on:
  pull_request:
    paths:
      - "forecaster/**"
      - "horizon_scanner/**"
      - "pythia/**"
      - "python_library_requirements.txt"
      - ".github/workflows/forecaster-ci.yml"

  workflow_dispatch:
    inputs:
      spd_mode:
        description: "SPD mode for this run"
        required: true
        default: "default"
        type: choice
        options:
          - default
          - dual_compare
          - bayesmc_write
          - dual_compare_bayesmc_write
      run_spd_smoke:
        description: "Run one-question SPD smoke compare (writes spd-compare-smoke artifact)"
        required: false
        default: "false"
        type: choice
        options: ["false", "true"]
      smoke_iso3:
        description: "Smoke ISO3"
        required: false
        default: "SOM"
        type: string
      smoke_hazard:
        description: "Smoke hazard code"
        required: false
        default: "ACE"
        type: string
      smoke_metric:
        description: "Smoke metric"
        required: false
        default: "PA"
        type: string
      smoke_target_month:
        description: "Smoke target month (YYYY-MM)"
        required: false
        default: "2025-12"
        type: string

jobs:
  forecaster-spd-tests:
    runs-on: ubuntu-latest
    env:
      RESOLVER_DB_URL: duckdb:///${{ github.workspace }}/data/resolver.duckdb

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Ensure resolver DB file exists (placeholder)
        shell: bash
        run: |
          mkdir -p data
          if [ ! -f "data/resolver.duckdb" ]; then
            echo "Creating empty placeholder data/resolver.duckdb"
            : > data/resolver.duckdb
          fi

      - name: Check canonical DB presence
        run: |
          ls -R data || true
          if [ ! -f data/resolver.duckdb ]; then
            echo "WARNING: data/resolver.duckdb not found; Forecaster will run on a fresh DB."
          fi

      - name: Debug context (ref, SHA, changed files)
        env:
          GITHUB_REF_SAFE: ${{ github.ref }}
          GITHUB_BASE_REF_SAFE: ${{ github.base_ref }}
          GITHUB_HEAD_REF_SAFE: ${{ github.head_ref }}
          GITHUB_SHA_SAFE: ${{ github.sha }}
        run: |
          echo "Ref: ${GITHUB_REF_SAFE}"
          echo "Base ref: ${GITHUB_BASE_REF_SAFE}"
          echo "Head ref: ${GITHUB_HEAD_REF_SAFE}"
          echo "SHA: ${GITHUB_SHA_SAFE}"
          echo "Changed files (base..head):"
          # This can fail on some PR types; don't fail the job if it does
          if [ -n "${GITHUB_BASE_REF_SAFE}" ]; then
            git fetch origin "${GITHUB_BASE_REF_SAFE}" --depth=1 || true
            git diff --name-only "origin/${GITHUB_BASE_REF_SAFE}"...HEAD || true
          else
            echo "No base_ref available (e.g. direct push); skipping git diff."
          fi
          echo "Repo tree (top-level):"
          ls -R

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"

      - name: Install dependencies (minimal, via python_library_requirements.txt)
        run: |
          python -m pip install --upgrade pip
          pip install -r python_library_requirements.txt
          pip install pytest

      - name: === Running Forecaster SPD unit tests ===
        env:
          PYTHIA_DEBUG_SPD: "1"
          PYTHIA_DEBUG_DB: "1"
          PYTHIA_SPD_V2_DUAL_RUN: "0"
          PYTHIA_SPD_V2_USE_BAYESMC: "0"
        run: |
          echo "=== Running Forecaster SPD unit tests ==="
          pytest -vv forecaster/tests/test_spd.py

      - name: Run SPD experimental mode (dual/bayesmc)
        if: github.event_name == 'workflow_dispatch' && github.event.inputs.spd_mode != 'default'
        env:
          PYTHIA_DEBUG_SPD: "1"
          PYTHIA_DEBUG_DB: "1"
          PYTHIA_SPD_V2_DUAL_RUN: ${{ (github.event.inputs.spd_mode == 'dual_compare' || github.event.inputs.spd_mode == 'dual_compare_bayesmc_write') && '1' || '0' }}
          PYTHIA_SPD_V2_USE_BAYESMC: ${{ (github.event.inputs.spd_mode == 'bayesmc_write' || github.event.inputs.spd_mode == 'dual_compare_bayesmc_write') && '1' || '0' }}
        run: |
          echo "=== Running SPD experimental mode ==="
          echo "spd_mode=${{ github.event.inputs.spd_mode }}"
          echo "PYTHIA_SPD_V2_DUAL_RUN=$PYTHIA_SPD_V2_DUAL_RUN"
          echo "PYTHIA_SPD_V2_USE_BAYESMC=$PYTHIA_SPD_V2_USE_BAYESMC"
          pytest -vv forecaster/tests/test_spd.py -k "bayesmc_flag or spd_bayesmc_flag"

      - name: Run SPD smoke compare (workspace)
        if: github.event_name == 'workflow_dispatch' && github.event.inputs.run_spd_smoke == 'true'
        env:
          PYTHONPATH: ${{ github.workspace }}
          PYTHIA_SPD_V2_DUAL_RUN: ${{ (github.event.inputs.spd_mode == 'dual_compare' || github.event.inputs.spd_mode == 'dual_compare_bayesmc_write') && '1' || '0' }}
          PYTHIA_SPD_V2_USE_BAYESMC: ${{ (github.event.inputs.spd_mode == 'bayesmc_write' || github.event.inputs.spd_mode == 'dual_compare_bayesmc_write') && '1' || '0' }}
          PYTHIA_SPD_COMPARE_DIR: "debug/spd_compare_smoke"

          SPD_SMOKE_RUN_ID: smoke_${{ github.run_id }}
          SPD_SMOKE_ISO3: ${{ github.event.inputs.smoke_iso3 }}
          SPD_SMOKE_HAZARD: ${{ github.event.inputs.smoke_hazard }}
          SPD_SMOKE_METRIC: ${{ github.event.inputs.smoke_metric }}
          SPD_SMOKE_TARGET_MONTH: ${{ github.event.inputs.smoke_target_month }}
          SPD_SMOKE_QID: SMOKE_${{ github.event.inputs.smoke_iso3 }}_${{ github.event.inputs.smoke_hazard }}_${{ github.event.inputs.smoke_metric }}_${{ github.event.inputs.smoke_target_month }}
        run: |
          mkdir -p debug/spd_compare_smoke
          PYTHIA_DEBUG_MODELS=1 python scripts/print_forecaster_ensemble.py
          python -u scripts/run_spd_dual_smoke.py

      - name: Assert smoke compare JSON exists
        if: github.event_name == 'workflow_dispatch' && github.event.inputs.run_spd_smoke == 'true'
        shell: bash
        run: |
          echo "Smoke compare dir contents:"
          ls -la debug/spd_compare_smoke || true
          test -n "$(find debug/spd_compare_smoke -maxdepth 1 -type f -name '*.json' -print -quit)" || (echo "No smoke compare JSON produced" && exit 1)

      - name: Collect SPD compare JSONs from pytest temp dirs
        if: always() && github.event_name == 'workflow_dispatch' && (github.event.inputs.spd_mode == 'dual_compare' || github.event.inputs.spd_mode == 'dual_compare_bayesmc_write')
        shell: bash
        run: |
          mkdir -p debug/spd_compare_tests
          # Copy any compare JSONs produced under pytest tmp dirs into the workspace
          find /tmp/pytest-of-runner -type f -path "*/debug/spd_compare/*.json" -print -exec cp {} debug/spd_compare_tests/ \; || true
          echo "Collected unit test compare JSON count:"
          find debug/spd_compare_tests -maxdepth 1 -type f -name '*.json' -print | wc -l || true

      - name: Upload SPD compare test artifacts
        if: always() && github.event_name == 'workflow_dispatch' && (github.event.inputs.spd_mode == 'dual_compare' || github.event.inputs.spd_mode == 'dual_compare_bayesmc_write')
        uses: actions/upload-artifact@v4
        with:
          name: spd-compare-tests
          path: debug/spd_compare_tests/*.json
          if-no-files-found: warn

      - name: Upload SPD smoke compare artifacts
        if: always() && github.event_name == 'workflow_dispatch' && github.event.inputs.run_spd_smoke == 'true'
        uses: actions/upload-artifact@v4
        with:
          name: spd-compare-smoke
          path: debug/spd_compare_smoke/*.json
          if-no-files-found: warn
