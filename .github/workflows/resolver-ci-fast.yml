---
name: Resolver CI â€” Fast

on:
  push:
  pull_request:
  workflow_dispatch:

concurrency:
  group: resolver-fast-${{ github.ref }}
  cancel-in-progress: true

jobs:
  fast-tests:
    name: Fast tests
    runs-on: ubuntu-latest

    # Keep a label available for artifact naming even without a matrix
    env:
      duckdb_label: default

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"

      - name: Install dependencies (fast)
        run: |
          set -o pipefail
          python -m pip install --upgrade pip
          # Try project extras if defined; fall back to essentials
          python -m pip install -e ".[test]" || true
          python -m pip install duckdb pytest || true
          python -c "import sys,duckdb,pytest; print('DuckDB:', duckdb.__version__,'Pytest OK on', sys.version)"

      - name: Run fast tests
        id: tests
        continue-on-error: true
        run: |
          set -o pipefail
          mkdir -p .ci/diagnostics
          python -m pytest -q resolver/tests -k "not slow and not nightly" --junitxml=pytest-junit.xml

      - name: Package diagnostics (always)
        if: always()
        run: |
          set +e
          mkdir -p .ci/diagnostics
          # Include JUnit if produced
          [ -f pytest-junit.xml ] && cp -f pytest-junit.xml .ci/diagnostics/ || true
          # Collect logs & small DB files within repo (avoid system dirs)
          tar -czf "diagnostics_${{ github.job }}_${{ env.duckdb_label }}.tar.gz" \
            --exclude-vcs --ignore-failed-read \
            .ci/diagnostics \
            $(git ls-files '*.log' 2>/dev/null) \
            $(git ls-files '*.duckdb' 2>/dev/null) 2>/dev/null || true
          # Fallback: if no tarball was created, touch an empty one so upload step finds at least one file
          [ -f "diagnostics_${{ github.job }}_${{ env.duckdb_label }}.tar.gz" ] || \
            tar -czf "diagnostics_${{ github.job }}_${{ env.duckdb_label }}.tar.gz" .ci/diagnostics 2>/dev/null || true
          set -e

      - name: Upload diagnostics bundle (always)
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: diagnostics-${{ github.job }}-${{ env.duckdb_label }}-run${{ github.run_attempt }}
          path:
            - diagnostics_*.tar.gz
            - .ci/diagnostics/**
          if-no-files-found: warn
          overwrite: true

      - name: Respect test outcome
        if: ${{ always() && steps.tests.outcome == 'failure' }}
        run: exit 1
