name: Weekly Calibration Refresh

on:
  workflow_dispatch:
  schedule:
    # Every Monday at 06:00 UTC (09:00 Istanbul)
    - cron: "0 6 * * 1"

permissions:
  contents: write
  actions: read

concurrency:
  group: ${{ github.workflow }}
  cancel-in-progress: false

jobs:
  refresh:
    runs-on: ubuntu-latest

    env:
      # ---- Required and identity ----
      GIT_SHA: ${{ github.sha }}
      METACULUS_TOKEN: ${{ secrets.METACULUS_TOKEN }}

      # ---- Collections included in calibration (code reads by tournament id/collection) ----
      TOURNAMENT_ID: fall-aib-2025
      METACULUS_INCLUDE_RESOLVED: "1"   # calibration needs resolutions

      # ---- Research (generally not needed for calibration, keep disabled) ----
      ENABLE_SERPER: "0"
      ENABLE_SERPER_WEB: "0"
      ENABLE_ASKNEWS: "0"

      # ---- LLM Providers (not needed here; keep off) ----
      USE_OPENROUTER: "0"
      USE_GOOGLE: "0"
      ENABLE_GROK: "0"

      # ---- Paths for calibration artifacts ----
      CALIBRATION_PATH: calibration/calibration_state.json
      CALIB_WEIGHTS_PATH: calibration/calibration_weights.json
      CALIB_ADVICE_PATH: calibration/calibration_advice.json

      # ---- CSV output path for logs (optional; defaults exist) ----
      FORECASTS_CSV_PATH: forecasts.csv

      # ---- Cache toggles ----
      SPAGBOT_DISABLE_RESEARCH_CACHE: "1"  
      SPAGBOT_DISABLE_CLASSIFIER_CACHE: "0"

      # ---- Misc knobs used by code (safe defaults) ----
      LLM_MAX_CONCURRENCY: "4"
      RESEARCH_SNIPPET_MAX_CHARS: "600"
      HUMAN_LOG_MODEL_RAW_MAX_CHARS: "5000"
      HUMAN_LOG_RESEARCH_MAX_CHARS: "15000"

      # ---- Cost table (string JSON) ----
      MODEL_COSTS_JSON: |
        {"openai/gpt-4o":{"prompt":2.5,"completion":10.0},"anthropic/claude-3.7-sonnet":{"prompt":3.0,"completion":15.0},"gemini-2.5-pro":{"prompt":1.25,"completion":10.0},"grok-4":{"prompt":3.0,"completion":15.0}}

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"

      - name: Install Poetry
        run: pipx install poetry

      - name: Install deps
        run: poetry install --no-interaction --no-ansi

      - name: Refresh calibration (pull resolutions and update weights)
        run: poetry run python update_calibration.py

      - name: Commit calibration artifacts (if changed)
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          git add calibration/*.json || true
          if ! git diff --cached --quiet; then
            git commit -m "chore: weekly calibration refresh [skip ci]"
            git push
          else
            echo "No calibration changes to commit."
          fi
